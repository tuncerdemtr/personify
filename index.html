<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>İntema Mutfak Dijital Mimar Asistanı</title>
  <style>
    :root{
      --bg0:#f7f9fc;
      --bg1:#eef3f9;
      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.94);
      --stroke: rgba(15,32,56,.08);
      --stroke2: rgba(15,32,56,.12);
      --text:#1a2433;
      --muted: rgba(26,36,51,.7);
      --muted2: rgba(26,36,51,.48);
      --good: rgba(114,210,170,.2);
      --warn: rgba(255,200,140,.2);
      --bad: rgba(255,140,140,.2);
      --shadow: 0 24px 60px rgba(21,40,70,.12);
      --shadow-soft: 0 18px 50px rgba(17,32,58,.12);
      --shadow-lite: 0 10px 26px rgba(17,32,58,.08);
      --glow: radial-gradient(120% 120% at 15% 10%, rgba(255,255,255,.9), rgba(255,255,255,0) 58%);
      --r: 18px;
      --r2: 14px;
      --pad: 18px;
      --btn: rgba(255,255,255,.85);
      --btn2: rgba(255,255,255,1);
      --focus: rgba(120,170,255,.24);
      --maxw: 100%;
      --tap: 52px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(255,255,255,.9), transparent 55%),
        radial-gradient(900px 540px at 80% 0%, rgba(190,220,255,.45), transparent 60%),
        radial-gradient(900px 560px at 70% 95%, rgba(255,225,190,.42), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      padding: 8px 4px 14px;
    }

    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand .kicker{
      font-size:12px;
      color: var(--muted2);
      letter-spacing:.12em;
      text-transform: uppercase;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      line-height:1.25;
      font-weight: 650;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 68ch;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .pill strong{ color: var(--text); font-weight:650; }

    .btn{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: var(--btn);
      color: var(--text);
      font-size: 14px;
      font-weight: 650;
      letter-spacing:.1px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      box-shadow: 0 14px 30px rgba(18,34,60,.12);
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn:hover{ background: var(--btn2); border-color: rgba(255,255,255,.18); }
    .btn:focus{ outline:none; box-shadow: 0 0 0 4px var(--focus); }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }
    .btn.primary{
      background: rgba(160,205,255,.4);
      border-color: rgba(120,170,255,.45);
    }
    .btn.primary:hover{
      background: rgba(160,205,255,.52);
      border-color: rgba(120,170,255,.6);
    }
    .btn.danger{
      background: rgba(255,160,160,.24);
      border-color: rgba(255,160,160,.4);
    }

    @media (max-width: 920px){
      header{ align-items:flex-start; }
      .topActions{ justify-content:flex-start; }
    }

    .card{
      background:
        var(--glow),
        linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.86));
      border: 1px solid var(--stroke);
      border-radius: calc(var(--r) + 2px);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px var(--pad);
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
      font-weight: 700;
    }
    .cardHeader .sub{
      margin:0;
      color: var(--muted2);
      font-size: 12px;
      margin-top:2px;
    }
    .cardBody{ padding: var(--pad); }

    .screen{
      animation: fadeSlide .35s ease;
    }
    @keyframes fadeSlide{
      from{ opacity: 0; transform: translateY(8px); }
      to{ opacity: 1; transform: translateY(0); }
    }

    .stack{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .fieldRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .fieldRow{ grid-template-columns: 1fr; }
    }

    label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    input[type="text"], input[type="tel"], input[type="email"], textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.85);
      color: var(--text);
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, textarea:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(140,200,255,.45);
    }
    .hint{
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
      margin-top: 2px;
    }

    .progressWrap{
      padding: 12px var(--pad);
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .progressLeft{
      display:flex;
      flex-direction:column;
      gap: 3px;
    }
    .qMeta{
      color: var(--muted2);
      font-size: 12px;
      letter-spacing:.2px;
    }
    .qText{
      font-size: 18px;
      font-weight: 720;
      margin:0;
      line-height:1.2;
      letter-spacing:.1px;
    }
    .bar{
      width: 260px;
      height: 10px;
      border-radius: 999px;
      background: rgba(15,32,56,.06);
      border: 1px solid var(--stroke);
      overflow:hidden;
      flex: 0 0 auto;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: rgba(120,170,255,.45);
      border-right: 1px solid rgba(120,170,255,.6);
      transition: width .18s ease;
    }
    @media (max-width: 560px){
      .bar{ width: 160px; }
      .qText{ font-size: 16px; }
    }

    .options{
      display:grid;
      gap: 10px;
      margin-top: 14px;
    }
    .opt{
      border-radius: 16px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.8);
      padding: 14px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      min-height: 56px;
    }
    .opt:hover{ background: rgba(255,255,255,.95); border-color: rgba(120,170,255,.35); }
    .opt:active{ transform: translateY(1px); }
    .opt.sel{
      background: rgba(160,205,255,.35);
      border-color: rgba(120,170,255,.5);
    }
    .opt .t{
      font-size: 15px;
      font-weight: 650;
      line-height:1.25;
    }
    .opt .tag{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted2);
    }
    .opt .mark{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(80,110,150,.3);
      background: rgba(255,255,255,.7);
      margin-top: 2px;
      flex: 0 0 auto;
      position:relative;
    }
    .opt.sel .mark{
      border-color: rgba(120,170,255,.6);
      background: rgba(160,205,255,.4);
    }
    .opt.sel .mark::after{
      content:"";
      position:absolute; inset: 4px;
      border-radius:999px;
      background: rgba(140,200,255,.75);
    }
    .opt.multi .mark{ border-radius: 6px; }
    .opt.multi.sel .mark::after{ border-radius: 4px; }

    .navRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .navRow .left, .navRow .right{
      display:flex; gap:10px; flex-wrap:wrap;
    }

    .mini{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 8px;
      line-height:1.35;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .badge strong{ color: var(--text); font-weight: 750; }
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 14px var(--pad);
    }
    .split.bento{
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 14px;
    }

    .panel{
      border-radius: calc(var(--r2) + 2px);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      padding: 12px 12px;
      box-shadow: var(--shadow-lite);
      position: relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:0;
      background: var(--glow);
      opacity:.7;
      pointer-events:none;
    }
    .panel > *{
      position:relative;
      z-index:1;
    }

    .bento-card{
      backdrop-filter: blur(6px);
    }
    .bento-meta{ grid-column: span 7; }
    .bento-recipe{ grid-column: span 5; }
    .bento-alert,
    .bento-pet{ grid-column: span 6; }
    .bento-scores{ grid-column: span 5; }
    .bento-note{ grid-column: span 7; }

    @media (max-width: 980px){
      .split.bento{ grid-template-columns: repeat(8, minmax(0, 1fr)); }
      .bento-meta,
      .bento-recipe,
      .bento-alert,
      .bento-pet,
      .bento-scores,
      .bento-note{ grid-column: span 8; }
    }
    @media (max-width: 640px){
      .split.bento{ grid-template-columns: 1fr; }
      .bento-meta,
      .bento-recipe,
      .bento-alert,
      .bento-pet,
      .bento-scores,
      .bento-note{ grid-column: auto; }
    }

    .panel h3{
      margin:0 0 8px 0;
      font-size: 13px;
      font-weight: 780;
      letter-spacing:.2px;
    }
    .panel ul{
      margin:0;
      padding-left: 18px;
      color: var(--muted);
      line-height:1.45;
      font-size: 13px;
    }
    .panel p{
      margin:0;
      color: var(--muted);
      line-height:1.45;
      font-size: 13px;
    }

    .mediaGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .mediaCard{
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      overflow:hidden;
      box-shadow: var(--shadow-lite);
    }
    .mediaCard img{
      display:block;
      width:100%;
      height: 140px;
      object-fit: cover;
    }
    .mediaCard .label{
      padding: 8px 10px 10px;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
    }

    .loadingWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 320px;
      text-align:center;
    }
    .loadingCard{
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:center;
    }
    .spinner{
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 3px solid rgba(120,170,255,.25);
      border-top-color: rgba(120,170,255,.8);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    .resultHero{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-lite);
    }
    .resultHero img{
      display:block;
      width:100%;
      height: 280px;
      object-fit: cover;
    }
    .resultHeader{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .resultHeader h2{
      margin:0;
      font-size: 22px;
      font-weight: 760;
    }
    .resultHeader p{
      margin:0;
      color: var(--muted);
      line-height:1.5;
      font-size: 14px;
    }

    .swatchGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }
    .swatch{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.8);
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }
    .swatchDot{
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.6);
      flex: 0 0 auto;
    }

    .checklist{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .checklist li{
      display:flex;
      align-items:flex-start;
      gap: 8px;
    }
    .checklist li::before{
      content:"✓";
      color: rgba(80,160,120,.95);
      font-weight: 800;
      font-size: 14px;
      line-height:1.2;
      margin-top: 2px;
    }

    .ctaRow{
      display:flex;
      justify-content:flex-start;
    }
    .ctaRow .btn{
      text-decoration:none;
    }

    .alert{
      background:
        var(--glow),
        var(--warn);
      border-color: rgba(255,190,120,.32);
    }
    .ok{
      background:
        var(--glow),
        var(--good);
      border-color: rgba(120,255,180,.28);
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.85);
    }
    th, td{
      text-align:left;
      padding: 10px 10px;
      border-bottom: 1px solid var(--stroke);
      font-size: 12px;
      color: var(--muted);
    }
    th{
      color: var(--muted2);
      font-weight: 800;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: 11px;
      background: rgba(15,32,56,.04);
    }
    tr:last-child td{ border-bottom: 0; }
    td strong{ color: var(--text); font-weight: 750; }

    .hide{ display:none !important; }

    .footerNote{
      color: var(--muted2);
      font-size: 12px;
      line-height:1.45;
      padding: 10px 4px 0;
    }

    .kbd{
      padding: 3px 7px;
      border-radius: 9px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.9);
      color: var(--muted);
      font-weight: 750;
      font-size: 11px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="kicker">Sales Point Tablet App</div>
        <h1>İntema Mutfak Dijital Mimar Asistanı</h1>
        <p>14 soruluk akış. 7 persona skoru. Sonuç ekranında kişisel model ve aksesuar önerisi öne çıkar.</p>
      </div>
      <div class="topActions">
        <div class="pill" id="sessionPill"><strong>Oturum:</strong> <span id="sessionState">Yeni</span></div>
        <button class="btn ghost" id="btnNew">Yeni Görüşme</button>
        <button class="btn danger" id="btnReset">Sıfırla</button>
      </div>
    </header>

    <div class="card" id="mainCard"></div>

    <div class="footerNote">
      Bu uygulama tek dosya çalışır. Veri sadece bu cihazın tarayıcısında saklanır (LocalStorage).
    </div>
  </div>

  <script>
    // --- REVİZE EDİLMİŞ DENGELİ SORU HAVUZU (MAX PUAN ~100 EŞİTLENDİ) ---
    const questions = [
      {
        id: 1, text: "Bu mutfak projesinin niteliği nedir?", type: "single",
        options: [
          { text: "Kendi evim / Tadilat", scores: { konforodakli: 12, dogalruh: 6 } },
          { text: "Yeni Ev / Sıfır Proje", scores: { sehirlivizyoner: 14, klasikluk: 10 } },
          { text: "Yatırım / Stüdyo / Kiraya verilecek", scores: { hizpratik: 26 } },
          { text: "Yazlık / İkinci Ev", scores: { sahilruhu: 28 } }
        ]
      },
      {
        id: 2, text: "Zaman kısıtınız nedir?", type: "single",
        options: [
          { text: "Çok acil, hemen bitmeli", scores: { hizpratik: 30 } },
          { text: "Standart süreç (1-2 ay)", scores: { konforodakli: 12 } },
          { text: "Zaman sorun değil, mükemmel olsun", scores: { klasikluk: 14, dogalruh: 10, sehirlivizyoner: 8 } }
        ]
      },
      {
        id: 3, text: "Mutfak alanının durumu?", type: "single",
        options: [
          { text: "Dar / Küçük", scores: { hizpratik: 20 } },
          { text: "Geniş / Ada Müsait", scores: { sehirlivizyoner: 14, klasikluk: 12, sahilruhu: 8 } },
          { text: "Standart", scores: { konforodakli: 10 } }
        ]
      },
      {
        id: 4, text: "Hane Halkı (Birden fazla seçebilirsiniz)", type: "multi",
        options: [
          { text: "Yalnız / Çift", scores: { sehirlivizyoner: 10, hizpratik: 8 } },
          { text: "Çocuklar Var", scores: { konforodakli: 18 } },
          { text: "Evcil Hayvan Var", scores: { dogalruh: 12, konforodakli: 6 } },
          { text: "Kalabalık Aile", scores: { konforodakli: 12, nostaljik: 8 } }
        ]
      },
      {
        id: 5, text: "Mutfak sizin için ne ifade ediyor?", type: "single",
        options: [
          { text: "Vitrin (Sosyal Alan)", scores: { sehirlivizyoner: 20, klasikluk: 12 } },
          { text: "Operasyon (Yemek Yapma)", scores: { hizpratik: 14 } },
          { text: "Sığınak (Huzur)", scores: { dogalruh: 18 } },
          { text: "Kalp (Aile Odaklı)", scores: { konforodakli: 16, nostaljik: 12 } },
          { text: "İstasyon (Pratik)", scores: { hizpratik: 18 } }
        ]
      },
      {
        id: 6, text: "Şu anki mutfakta en büyük şikayetiniz?", type: "single",
        options: [
          { text: "Dağınıklık / Yer yok", scores: { konforodakli: 16 } },
          { text: "Temizlik Zorluğu / Lekeler", scores: { konforodakli: 12, hizpratik: 8 } },
          { text: "Demode Görünüm", scores: { sehirlivizyoner: 12, klasikluk: 10, nostaljik: 6 } },
          { text: "Karanlık / Basık", scores: { dogalruh: 12, sahilruhu: 12 } }
        ]
      },
      {
        id: 7, text: "Hangi tasarım dili size yakın?", type: "single",
        options: [
          { text: "Modern & Minimal", scores: { sehirlivizyoner: 18, hizpratik: 8 } },
          { text: "Klasik & Gösterişli", scores: { klasikluk: 22 } },
          { text: "Country & Doğal", scores: { dogalruh: 18, nostaljik: 14, sahilruhu: 10 } },
          { text: "Endüstriyel", scores: { sehirlivizyoner: 12, hizpratik: 10 } }
        ]
      },
      {
        id: 8, text: "Malzeme ve Doku tercihiniz?", type: "single",
        options: [
          { text: "Doğal Ahşap Dokusu", scores: { dogalruh: 20, nostaljik: 10 } },
          { text: "Mat ve Soft Renkler", scores: { konforodakli: 12, sahilruhu: 10 } },
          { text: "Parlak ve Canlı", scores: { klasikluk: 18 } },
          { text: "Koyu ve Maskülen", scores: { sehirlivizyoner: 16 } }
        ]
      },
      {
        id: 9, text: "Yemek pişirme alışkanlığınız?", type: "single",
        options: [
          { text: "Standart Pişirme", scores: { konforodakli: 10 } },
          { text: "Gurme / Profesyonel", scores: { sehirlivizyoner: 10, klasikluk: 8 } },
          { text: "Minimum / Pratik", scores: { hizpratik: 18 } }
        ]
      },
      {
        id: 10, text: "Depolama ihtiyacınız?", type: "single",
        options: [
          { text: "Maksimum Kiler / Stok", scores: { konforodakli: 18 } },
          { text: "Vitrin / Sergileme", scores: { klasikluk: 16, sehirlivizyoner: 10 } },
          { text: "Standart / Kapalı Dolap", scores: { hizpratik: 10 } }
        ]
      },
      {
        id: 11, text: "Sürdürülebilirlik önceliğiniz?", type: "single",
        options: [
          { text: "Çok Önemli / Vazgeçilmez", scores: { dogalruh: 28 } },
          { text: "Önemli ama estetik de önemli", scores: { dogalruh: 12, sahilruhu: 8, konforodakli: 6 } },
          { text: "Öncelik Değil", scores: { hizpratik: 8 } }
        ]
      },
      {
        id: 12, text: "Teknoloji entegrasyonu?", type: "single",
        options: [
          { text: "High-Tech (Akıllı sistemler)", scores: { sehirlivizyoner: 22 } },
          { text: "Geleneksel / Manuel", scores: { nostaljik: 16, klasikluk: 12 } }
        ]
      },
      {
        id: 13, text: "Bütçe yaklaşımınız?", type: "single",
        options: [
          { text: "Esnek / Prestij Odaklı", scores: { klasikluk: 20, sehirlivizyoner: 12 } },
          { text: "Fiyat / Performans", scores: { konforodakli: 14, hizpratik: 12 } },
          { text: "Ekonomik / Bütçe Dostu", scores: { hizpratik: 18 } }
        ]
      },
      {
        id: 14, text: "Karar verme faktörünüz?", type: "single",
        options: [
          { text: "Tasarım Heyecanı", scores: { sehirlivizyoner: 12, klasikluk: 8 } },
          { text: "Güven / Garanti", scores: { konforodakli: 12 } },
          { text: "Hız / Teslimat", scores: { hizpratik: 16 } },
          { text: "Maliyet", scores: { hizpratik: 10 } }
        ]
      }
    ];

    // Persona verisi: sonuç ekranındaki aksesuar, renk, malzeme önerileri buradan gelir
    const personasList = [
      {
        id: "sehirlivizyoner",
        title: "Şehirli Vizyoner (The Urban Visionary)",
        description: "Mutfak senin için bir vitrin. Trendleri takip ediyor, teknolojiyi ve modernizmi seviyorsun.",
        recommendedModel: "Inova",
        style: "Modern & Minimal",
        materials: ["Mat Lake", "Metal Görünümlü Yüzeyler"],
        colors: ["M104_Grafit", "T112_Koyu Taupe", "M007_Siyah"],
        accessories: [
          "Kulpsuz Gola Profil Sistemi (Mat Siyah)",
          "Hareket Sensörlü LED Aydınlatma (Gövde İçi)",
          "Blum Antaro Çekmece İçi Düzenleyici (Orion Gri)"
        ],
        features: ["Teknolojik Entegrasyon", "Minimalist Hatlar", "Koyu Renk Paleti"],
        imageQuery: "modern dark graphite luxury kitchen with led lights"
      },
      {
        id: "klasikluk",
        title: "Klasik Lüks Sever (The Heritage Luxury)",
        description: "Kalite asla modası geçmeyen bir yatırımdır. Geleneksel çizgilerin ağırbaşlılığını arıyorsun.",
        recommendedModel: "Toscana",
        style: "Neo-Klasik",
        materials: ["Parlak Lake", "Masif Çerçeve"],
        colors: ["P019_Orman Yeşili", "P020_Uzay Mavi", "P017_İnci Beyaz"],
        accessories: [
          "Gold (Altın) Kulp - Kod: MKGDK33FP0032",
          "Klasik Taç ve Işık Bandı Profilleri",
          "Büfe Tipi Camlı Üst Dolaplar (Sable Cam)"
        ],
        features: ["Gösterişli Detaylar", "Simetrik Yerleşim", "Zengin Aksesuarlar"],
        imageQuery: "classic green luxury kitchen cabinets gold handles"
      },
      {
        id: "konforodakli",
        title: "Konfor Odaklı Aile (The Comfort Family)",
        description: "Mutfak evin kalbidir. Senin için dayanıklılık, temizlik kolaylığı ve bolca saklama alanı her şeyden önemli.",
        recommendedModel: "Siena",
        style: "Fonksiyonel & Sıcak",
        materials: ["Akrilik PET (Çizilmez)", "Mat PET"],
        colors: ["T125_Manolya", "T123_Kaşmir", "T122_Açık Gri"],
        accessories: [
          "Boy Kiler Mekanizması (Tam Açılım)",
          "Fasulye Köşe Mekanizması (Kör Köşe Çözümü)",
          "Tezgah Altı Çöp Kovası Sistemleri"
        ],
        features: ["Maksimum Depolama", "Parmak İzi Bırakmayan Yüzey", "Ergonomi"],
        imageQuery: "cozy family kitchen beige cabinets bright"
      },
      {
        id: "dogalruh",
        title: "Doğal Ruh (The Natural Soul)",
        description: "Evin senin sığınağın. Doğal dokular, ahşap sıcaklığı ve sürdürülebilirlik önceliğin.",
        recommendedModel: "Norda",
        style: "İskandinav & Natural",
        materials: ["Doğal Ahşap Kaplama", "Geri Dönüştürülmüş PET"],
        colors: ["W009_Düşey Hareli Naturel Meşe", "T1_121_Adaçayı Yeşili", "M023_Beton Yeşili"],
        accessories: [
          "Ahşap Çekmece İçi Kaşıklık (Dişbudak)",
          "Metal Çerçeveli Ahşap Açık Raf Üniteleri",
          "Bitki Yetiştirme Modülü (Micro Garden)"
        ],
        features: ["Sürdürülebilir Malzeme", "Bitkisel Dokunuşlar", "Ferah Tasarım"],
        imageQuery: "scandinavian kitchen light wood green plants"
      },
      {
        id: "hizpratik",
        title: "Hız ve Pratiklik Odaklı (The Smart Investor)",
        description: "Kararını verdin, sonuç istiyorsun. Hızlı, ekonomik ama şık çözümler tam sana göre.",
        recommendedModel: "Prime",
        style: "Modern & Ekonomik",
        materials: ["Laminant", "Düz Melamin"],
        colors: ["M104_Grafit", "M103_Latte", "M101_Mat Beyaz"],
        accessories: [
          "Açılır Masa Mekanizması (Space Saver)",
          "Tezgah Arası Ray Sistemi (Askı Elemanları)",
          "Entegre Kulp (Kapak Kendinden Kulplu)"
        ],
        features: ["Hızlı Kurulum", "Modüler Yapı", "Fiyat/Performans"],
        imageQuery: "compact modern kitchen studio apartment"
      },
      {
        id: "nostaljik",
        title: "Nostaljik Romantik (The Vintage Lover)",
        description: "Geçmişin sıcaklığı, bugünün konforu. 'Anne mutfağı' sıcaklığında, duygusal bağ kurabileceğin bir yer.",
        recommendedModel: "Vega",
        style: "Country / Vintage",
        materials: ["Mat Lake", "Polimerik"],
        colors: ["V1_M021_Baltık Mavi", "T125_Manolya", "V1_M024_Buz Gri"],
        accessories: [
          "Antik Kulp (Eskitme) - Kod: MKGAK24MS0128",
          "Ahşap Tabaklık Rafı (Terek)",
          "Kafesli Tel Dolap Kapakları"
        ],
        features: ["Rustik Dokunuşlar", "Sıcak Atmosfer", "Detaylı İşçilik"],
        imageQuery: "vintage blue country kitchen rustic style"
      },
      {
        id: "sahilruhu",
        title: "Yazlık Ruhu (The Coastal Dreamer)",
        description: "Şehirde bile olsan mutfağında bir sahil evi ferahlığı arıyorsun. Çizgili dokular ve mavi tonlar vazgeçilmezin.",
        recommendedModel: "Fresca",
        style: "Akdeniz & Marin",
        materials: ["Mat Lake", "Mat PET"],
        colors: ["F1_M021_Baltık Mavi", "F1_M001_Buz Beyaz", "T1_120_Baltık Mavi"],
        accessories: [
          "Krom Kulp - Kod: MKGDK02EB0026",
          "Camlı Üst Dolaplar (Buzlu Cam)",
          "Açık Mavi/Beyaz Raf Sistemleri"
        ],
        features: ["Düşey Fuga Detayları", "Marin Esintiler", "Aydınlık Alanlar"],
        imageQuery: "coastal kitchen blue striped cabinets bright"
      }
    ];

    const personas = Object.fromEntries(personasList.map(p => [p.id, p]));
    const personaOrder = [
      "sehirlivizyoner",
      "klasikluk",
      "konforodakli",
      "dogalruh",
      "hizpratik",
      "nostaljik",
      "sahilruhu"
    ];

    const STORAGE_KEY = "intema_mimar_asistan_v4";

    const state = {
      step: "start",
      qIndex: 0,
      answers: {},
      meta: { name:"", phone:"", email:"", note:"" }
    };

    let loadingTimer = null;

    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(deepClone(state)));
      updateSessionPill();
      updateSideSummary();
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return false;
        const payload = JSON.parse(raw);
        if(!payload || typeof payload !== "object") return false;
        Object.assign(state, payload);
        return true;
      }catch(e){
        return false;
      }
    }

    function clearStorage(){ localStorage.removeItem(STORAGE_KEY); }

    function resetAll({ keepMeta=false } = {}){
      const preserved = keepMeta ? deepClone(state.meta) : { name:"", phone:"", email:"", note:"" };
      state.step = "start";
      state.qIndex = 0;
      state.answers = {};
      state.meta = preserved;
      if(loadingTimer){
        clearTimeout(loadingTimer);
        loadingTimer = null;
      }
      save();
      render();
    }

    function startQuiz(){
      state.step = "quiz";
      state.qIndex = Math.max(0, Math.min(state.qIndex || 0, questions.length - 1));
      save();
      render();
    }

    function startLoadingResult(){
      state.step = "loading";
      save();
      render();
      if(loadingTimer){
        clearTimeout(loadingTimer);
      }
      loadingTimer = setTimeout(()=>{
        state.step = "result";
        save();
        render();
      }, 2000);
    }

    function currentQuestion(){ return questions[state.qIndex]; }

    function isAnswered(q){
      const a = state.answers[q.id];
      if(q.type === "single") return typeof a === "number";
      if(q.type === "multi") return Array.isArray(a) && a.length > 0;
      return false;
    }

    function selectOption(q, optIndex){
      if(q.type === "single"){
        state.answers[q.id] = optIndex;
      }else{
        const cur = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [];
        state.answers[q.id] = cur.includes(optIndex) ? cur.filter(i=>i!==optIndex) : [...cur, optIndex];
      }
      save();
      render();
    }

    function totalProgress(){
      const answeredCount = questions.reduce((acc,q)=>acc + (isAnswered(q)?1:0), 0);
      return { answeredCount, total: questions.length };
    }

    function calcScores(){
      const scores = {};
      const contrib = {};
      personaOrder.forEach(p => scores[p] = 0);

      for(const q of questions){
        const ans = state.answers[q.id];
        if(ans === undefined) continue;

        contrib[q.id] = {};
        personaOrder.forEach(p => contrib[q.id][p] = 0);

        if(q.type === "single"){
          const opt = q.options[ans];
          if(opt && opt.scores){
            for(const [p,val] of Object.entries(opt.scores)){
              if(scores[p] === undefined) continue;
              scores[p] += val;
              contrib[q.id][p] += val;
            }
          }
        }else if(q.type === "multi"){
          const arr = Array.isArray(ans) ? ans : [];
          for(const idx of arr){
            const opt = q.options[idx];
            if(opt && opt.scores){
              for(const [p,val] of Object.entries(opt.scores)){
                if(scores[p] === undefined) continue;
                scores[p] += val;
                contrib[q.id][p] += val;
              }
            }
          }
        }
      }

      const total = Object.values(scores).reduce((a,b)=>a+b,0);
      return { scores, contrib, total };
    }

    function pickWinner({ scores, contrib }){
      const entries = personaOrder.map(p => ({ p, score: scores[p] }));
      entries.sort((a,b)=> b.score - a.score);

      const topScore = entries[0].score;
      const tied = entries.filter(e => e.score === topScore).map(e=>e.p);

      if(tied.length === 1){
        return { winner: tied[0], tied, reason: "max" };
      }

      const qBudget = 13;
      const qStyle = 7;

      const pickByContribution = (qId, candidates) => {
        const c = candidates.map(p => ({ p, c: (contrib[qId] && contrib[qId][p]) ? contrib[qId][p] : 0 }));
        c.sort((a,b)=> b.c - a.c);
        const maxC = c[0].c;
        const best = c.filter(x => x.c === maxC).map(x=>x.p);
        return { best, maxC };
      };

      const b1 = pickByContribution(qBudget, tied);
      if(b1.best.length === 1 && b1.maxC > 0){
        return { winner: b1.best[0], tied, reason: "tie_budget" };
      }

      const b2 = pickByContribution(qStyle, (b1.best.length ? b1.best : tied));
      if(b2.best.length === 1 && b2.maxC > 0){
        return { winner: b2.best[0], tied, reason: "tie_style" };
      }

      const fallback = personaOrder.find(p => tied.includes(p)) || tied[0];
      return { winner: fallback, tied, reason: "tie_fallback" };
    }

    function calcHybrid({ scores, total }){
      const entries = personaOrder.map(p => ({ p, score: scores[p] })).sort((a,b)=> b.score - a.score);
      const top1 = entries[0];
      const top2 = entries[1] || { p: top1.p, score: 0 };

      const topShare = total > 0 ? (top1.score / total) : 0;
      const isDominant = topShare >= 0.30;

      return {
        isDominant,
        top1,
        top2,
        topShare,
        top2Share: total > 0 ? (top2.score / total) : 0
      };
    }

    function petTriggered(){
      const ans = state.answers[4];
      return Array.isArray(ans) && ans.includes(2);
    }

    function childrenAndPetRisk(){
      const ans = state.answers[4];
      return Array.isArray(ans) && ans.includes(1) && ans.includes(2);
    }

    function formatPct(x){ return (x*100).toFixed(0) + "%"; }

    function resultPackage(){
      const { scores, contrib, total } = calcScores();
      const { winner, tied, reason } = pickWinner({ scores, contrib });
      const hybrid = calcHybrid({ scores, total });

      const list = personaOrder
        .map(p => ({ p, score: scores[p], share: total>0 ? scores[p]/total : 0 }))
        .sort((a,b)=> b.score - a.score);

      return { scores, total, winner, tied, reason, hybrid, list };
    }

    function buildSummaryText(res){
      if(!res.hybrid.isDominant){
        return `Hibrit profil: ${personas[res.hybrid.top1.p].title} (${formatPct(res.hybrid.topShare)}) + ${personas[res.hybrid.top2.p].title} (${formatPct(res.hybrid.top2Share)})`;
      }
      return `Kazanan profil: ${personas[res.winner].title} (${formatPct(res.hybrid.topShare)})`;
    }

    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(text);
      }
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    function render(){
      updateSessionPill();
      updateSideSummary();

      const main = el("#mainCard");
      if(state.step === "start"){
        main.innerHTML = renderStart();
        bindStart();
        return;
      }
      if(state.step === "quiz"){
        main.innerHTML = renderQuiz();
        bindQuiz();
        return;
      }
      if(state.step === "loading"){
        main.innerHTML = renderLoading();
        return;
      }
      if(state.step === "result"){
        main.innerHTML = renderResult();
        bindResult();
        return;
      }
      state.step = "start";
      save();
      main.innerHTML = renderStart();
      bindStart();
    }

    function renderStart(){
      const prog = totalProgress();
      const hasSaved = prog.answeredCount > 0;
      return `
        <div class="screen">
          <div class="cardHeader">
            <div>
              <h2>Görüşme Bilgisi</h2>
              <div class="sub">Opsiyonel alanlar. İstersen boş geç.</div>
            </div>
            <div class="toggleRow">
              ${hasSaved ? `<span class="badge"><strong>Kayıt:</strong> Devam edilebilir</span>` : `<span class="badge"><strong>Kayıt:</strong> Yeni</span>`}
            </div>
          </div>

          <div class="cardBody">
            <div class="stack">
              <div class="fieldRow">
                <label>
                  Müşteri Ad Soyad
                  <input type="text" id="metaName" placeholder="Örn: Ayşe Yılmaz" value="${escapeHtml(state.meta.name)}" />
                </label>
                <label>
                  Telefon
                  <input type="tel" id="metaPhone" placeholder="Örn: 05xx xxx xx xx" value="${escapeHtml(state.meta.phone)}" />
                </label>
              </div>

              <div class="fieldRow">
                <label>
                  E-posta
                  <input type="email" id="metaEmail" placeholder="Örn: ayse@mail.com" value="${escapeHtml(state.meta.email)}" />
                </label>
                <label>
                  İç Not (Kısa)
                  <input type="text" id="metaQuick" placeholder="Örn: Ada istiyor, teslim acil" value="" />
                </label>
              </div>

              <label>
                Proje Notu
                <textarea id="metaNote" placeholder="Kısa notlar, beklenti, kritik detaylar...">${escapeHtml(state.meta.note)}</textarea>
                <div class="hint">Notlar sadece bu cihazda saklanır.</div>
              </label>

              <div class="navRow">
                <div class="left">
                  <button class="btn ghost" id="btnContinue" ${hasSaved ? "" : "disabled"}>Devam Et</button>
                  <button class="btn" id="btnStartNew">Ankete Başla</button>
                </div>
                <div class="right">
                  <button class="btn danger" id="btnClearSaved">Kaydı Sil</button>
                </div>
              </div>

              <div class="mini">
                İpucu: Kayıt varsa <span class="kbd">Devam Et</span> kaldığın soruya gider. Yoksa 1. sorudan başlar.
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderQuiz(){
      const q = currentQuestion();
      const prog = totalProgress();
      const pct = Math.round(((state.qIndex) / (questions.length - 1)) * 100);
      const answered = isAnswered(q);

      const selected = state.answers[q.id];
      const optionHtml = q.options.map((o, idx) => {
        const isSel = q.type === "single"
          ? selected === idx
          : (Array.isArray(selected) && selected.includes(idx));

        const cls = ["opt", q.type === "multi" ? "multi" : "", isSel ? "sel" : ""].join(" ").trim();
        return `
          <div class="${cls}" data-opt="${idx}" role="button" tabindex="0" aria-pressed="${isSel}">
            <div>
              <div class="t">${escapeHtml(o.text)}</div>
              <div class="tag">${q.type === "multi" ? "Çoklu seçim" : "Tek seçim"}</div>
            </div>
            <div class="mark" aria-hidden="true"></div>
          </div>
        `;
      }).join("");

      const canNext = answered;
      const isLast = state.qIndex === questions.length - 1;

      return `
        <div class="screen">
          <div class="progressWrap">
            <div class="progressLeft">
              <div class="qMeta">Soru ${state.qIndex + 1} / ${questions.length} • Cevaplanan: ${prog.answeredCount}/${prog.total}</div>
              <p class="qText">${escapeHtml(q.text)}</p>
            </div>
            <div class="bar" aria-label="İlerleme">
              <div style="width:${pct}%"></div>
            </div>
          </div>

          <div class="cardBody">
            <div class="options" id="optList">${optionHtml}</div>

            <div class="navRow">
              <div class="left">
                <button class="btn ghost" id="btnBack" ${state.qIndex === 0 ? "disabled" : ""}>Geri</button>
                <button class="btn ${isLast ? "primary" : ""}" id="btnNext" ${canNext ? "" : "disabled"}>
                  ${isLast ? "Sonucu Gör" : "İleri"}
                </button>
              </div>
              <div class="right">
                <button class="btn ghost" id="btnJumpStart">Başlangıç</button>
                <button class="btn danger" id="btnClearAnswers">Cevapları Temizle</button>
              </div>
            </div>

            <div class="mini">
              ${q.type === "multi" ? "Birden fazla seçenek işaretleyebilirsin. İleri için en az bir seçim şart." : "İleri için seçim şart."}
            </div>
          </div>
        </div>
      `;
    }

    function renderLoading(){
      return `
        <div class="screen">
          <div class="cardHeader">
            <div>
              <h2>Sonuç Hazırlanıyor</h2>
              <div class="sub">Kişiselleştirme tamamlanmak üzere.</div>
            </div>
          </div>
          <div class="cardBody loadingWrap">
            <div class="loadingCard">
              <div class="spinner" aria-hidden="true"></div>
              <div>
                <div><strong>Katalog taranıyor...</strong></div>
                <div class="hint">Aksesuarlar eşleştiriliyor...</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderResult(){
      const res = resultPackage();
      const winner = personas[res.winner];
      const heroUrl = buildHeroUrl(winner.imageQuery);
      const colors = winner.colors.map(color => `
        <div class="swatch">
          <span class="swatchDot" style="background:${swatchColor(color)};"></span>
          ${escapeHtml(color)}
        </div>
      `).join("");
      const accessories = winner.accessories.map(item => `<li>${escapeHtml(item)}</li>`).join("");

      return `
        <div class="screen">
          <div class="cardHeader">
            <div class="resultHeader">
              <h2>${escapeHtml(winner.title)}</h2>
              <p>${escapeHtml(winner.description)}</p>
            </div>
            <div class="badge"><strong>Sonuç</strong> • ${formatPct(res.hybrid.topShare)}</div>
          </div>

          <div class="cardBody">
            <div class="stack">
              <div class="resultHero">
                <img src="${escapeHtml(heroUrl)}" alt="${escapeHtml(winner.title)} için mood görseli" loading="lazy" />
              </div>

              <div class="panel">
                <h3>Sizin İçin Seçilen Model</h3>
                <p><strong>${escapeHtml(winner.recommendedModel)}</strong></p>
              </div>

              <div class="panel">
                <h3>Önerilen Renkler</h3>
                <div class="swatchGrid">${colors}</div>
              </div>

              <div class="panel">
                <h3>Size Özel Aksesuarlar</h3>
                <ul class="checklist">${accessories}</ul>
              </div>

              <div class="ctaRow">
                <a class="btn primary" href="https://example.com/randevu" target="_blank" rel="noopener noreferrer">Bu Mutfağı Tasarla</a>
              </div>

              <div class="navRow">
                <div class="left">
                  <button class="btn ghost" id="btnBackToQuiz">Ankete Dön</button>
                </div>
                <div class="right">
                  <button class="btn ghost" id="btnPrint">Yazdır</button>
                  <button class="btn primary" id="btnNewFromResult">Yeni Görüşme</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function updateSessionPill(){
      const prog = totalProgress();
      el("#sessionState").textContent = (prog.answeredCount > 0) ? `Devam (${prog.answeredCount}/${prog.total})` : "Yeni";
    }

    function updateSideSummary(){
      const side = el("#sideSummary");
      if(!side) return;

      const prog = totalProgress();

      if(state.step === "result"){
        side.textContent = buildSummaryText(resultPackage());
        return;
      }

      if(prog.answeredCount === 0){
        side.textContent = "Başlamak için görüşme bilgisi gir veya direkt ankete başla.";
        return;
      }

      const q = questions[state.qIndex] || questions[0];
      side.textContent = `İlerleme: ${prog.answeredCount}/${prog.total}. Şu an: Soru ${state.qIndex+1}. ${isAnswered(q) ? "Seçildi." : "Seçim bekliyor."}`;
    }

    function bindStart(){
      const name = el("#metaName");
      const phone = el("#metaPhone");
      const email = el("#metaEmail");
      const note = el("#metaNote");
      const quick = el("#metaQuick");

      const sync = () => {
        state.meta.name = name.value.trim();
        state.meta.phone = phone.value.trim();
        state.meta.email = email.value.trim();
        state.meta.note = note.value.trim();
        save();
      };

      [name,phone,email,note].forEach(x => x.addEventListener("input", sync));

      if(quick){
        quick.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){
            e.preventDefault();
            const v = quick.value.trim();
            if(v){
              state.meta.note = (state.meta.note ? (state.meta.note + "\n") : "") + v;
              quick.value = "";
              save();
              render();
            }
          }
        });
      }

      const prog = totalProgress();
      el("#btnContinue").addEventListener("click", ()=>{
        if(prog.answeredCount === 0) return;
        startQuiz();
      });

      el("#btnStartNew").addEventListener("click", ()=>{
        state.qIndex = 0;
        state.step = "quiz";
        save();
        render();
      });

      el("#btnClearSaved").addEventListener("click", ()=>{
        clearStorage();
        resetAll({ keepMeta:false });
      });
    }

    function bindQuiz(){
      const q = currentQuestion();
      const optList = el("#optList");
      els(".opt", optList).forEach(node => {
        node.addEventListener("click", () => selectOption(q, Number(node.dataset.opt)));
        node.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            selectOption(q, Number(node.dataset.opt));
          }
        });
      });

      el("#btnBack").addEventListener("click", ()=>{
        if(state.qIndex <= 0) return;
        state.qIndex -= 1;
        save();
        render();
      });

      el("#btnNext").addEventListener("click", ()=>{
        if(!isAnswered(q)) return;
        if(state.qIndex >= questions.length - 1){
          startLoadingResult();
          return;
        }
        state.qIndex += 1;
        save();
        render();
      });

      el("#btnJumpStart").addEventListener("click", ()=>{
        state.step = "start";
        save();
        render();
      });

      el("#btnClearAnswers").addEventListener("click", ()=>{
        state.answers = {};
        state.qIndex = 0;
        save();
        render();
      });
    }

    function bindResult(){
      el("#btnBackToQuiz").addEventListener("click", ()=>{
        state.step = "quiz";
        state.qIndex = questions.length - 1;
        save();
        render();
      });

      el("#btnNewFromResult").addEventListener("click", ()=> resetAll({ keepMeta:true }));

      el("#btnPrint").addEventListener("click", ()=> window.print());
    }

    function flashPill(msg){
      const pill = el("#sessionPill");
      const old = el("#sessionState").textContent;
      el("#sessionState").textContent = msg;
      pill.style.borderColor = "rgba(140,200,255,.42)";
      pill.style.background = "rgba(140,200,255,.16)";
      setTimeout(()=>{
        pill.style.borderColor = "";
        pill.style.background = "";
        el("#sessionState").textContent = old;
      }, 900);
    }

    el("#btnNew").addEventListener("click", ()=> resetAll({ keepMeta:true }));
    el("#btnReset").addEventListener("click", ()=> resetAll({ keepMeta:false }));

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        e.preventDefault();
        resetAll({ keepMeta:true });
        return;
      }
      if(state.step !== "quiz") return;
      if(e.key === "ArrowLeft"){
        e.preventDefault();
        const b = el("#btnBack");
        if(b && !b.disabled) b.click();
      }
      if(e.key === "ArrowRight"){
        e.preventDefault();
        const n = el("#btnNext");
        if(n && !n.disabled) n.click();
      }
    });

    function unique(arr){
      const s = new Set();
      const out = [];
      for(const x of arr){
        if(!s.has(x)){ s.add(x); out.push(x); }
      }
      return out;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildHeroUrl(query){
      return `https://source.unsplash.com/1600x900/?${encodeURIComponent(query)}`;
    }

    function swatchColor(label){
      let hash = 0;
      for(let i = 0; i < label.length; i++){
        hash = label.charCodeAt(i) + ((hash << 5) - hash);
        hash |= 0;
      }
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue} 36% 70%)`;
    }

    const hasLoaded = load();
    if(!hasLoaded) save();

    if(state.step === "quiz" && (state.qIndex == null || isNaN(state.qIndex))) state.qIndex = 0;
    if(state.step === "result" && totalProgress().answeredCount === 0) state.step = "start";
    if(state.step === "loading") state.step = "result";

    render();
  </script>
</body>
</html>
