<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>İntema | Müşteri Analiz Asistanı</title>
  <style>
    :root{
      --bg:#0b0f14;
      --bg2:#070a0f;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --ring:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --accentA: rgba(155, 246, 255, .35);
      --accentB: rgba(199, 249, 204, .25);
      --accentC: rgba(189, 178, 255, .28);
      --danger: rgba(255, 193, 7, .18);
      --ok: rgba(16, 185, 129, .18);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);
      --radius: 22px;
      --radius2: 28px;
      --tap: 54px;
      --max: 1120px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% 15%, var(--accentA), transparent 55%),
                  radial-gradient(900px 600px at 80% 10%, var(--accentC), transparent 60%),
                  radial-gradient(900px 700px at 50% 90%, var(--accentB), transparent 55%),
                  linear-gradient(180deg, var(--bg2) 0%, var(--bg) 55%, #06080c 100%);
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 22px 18px 90px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 2px 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 220px;
    }
    .logo{
      width:40px;height:40px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--ring);
      box-shadow: var(--shadow2);
    }
    .brand small{
      display:block;
      text-transform:uppercase;
      letter-spacing:.22em;
      font-size:11px;
      color: var(--muted2);
    }
    .brand strong{
      display:block;
      font-size:14px;
      color: rgba(255,255,255,.86);
      font-weight:700;
      letter-spacing: .02em;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--ring);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .btn{
      height: 42px;
      padding: 0 14px;
      border-radius: 16px;
      border: 1px solid var(--ring);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.86);
      font-weight:700;
      font-size: 13px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: scale(.99); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn.primary{
      border-color: rgba(155,246,255,.22);
      background: linear-gradient(135deg, rgba(155,246,255,.18), rgba(199,249,204,.10));
    }
    .btn.primary:hover{
      background: linear-gradient(135deg, rgba(155,246,255,.24), rgba(199,249,204,.12));
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:start;
      margin-top: 10px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .wrap{ padding-bottom: 120px; }
    }

    .card{
      border-radius: var(--radius2);
      background: var(--card);
      border: 1px solid var(--ring);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .kicker{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .22em;
      color: var(--muted2);
    }
    .h1{
      margin: 10px 0 0;
      font-size: 20px;
      letter-spacing: -0.02em;
      font-weight: 800;
      color: rgba(255,255,255,.92);
    }
    .sub{
      margin: 8px 0 0;
      font-size: 14px;
      line-height: 1.55;
      color: var(--muted);
      max-width: 72ch;
    }
    .cardBody{ padding: 18px; }

    .progressRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .progress{
      min-width: 260px;
      width: 320px;
      max-width: 100%;
    }
    .progressTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size: 11px;
      color: var(--muted2);
      margin-bottom: 8px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(155,246,255,.70), rgba(199,249,204,.70));
      transition: width .18s ease;
    }

    .chips{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.78);
      font-size: 12px;
      font-weight: 700;
      backdrop-filter: blur(10px);
    }
    .chip.warn{ border-color: rgba(255,193,7,.22); background: var(--danger); color: rgba(255,243,205,.92); }
    .chip.ok{ border-color: rgba(16,185,129,.22); background: var(--ok); color: rgba(209,250,229,.92); }

    .qMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 13px;
    }
    .qMeta strong{ color: rgba(255,255,255,.86); }
    .qid{
      font-size: 11px;
      letter-spacing: .18em;
      color: var(--muted2);
      text-transform: uppercase;
    }

    .qCard{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .qHead{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .qType{
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: var(--muted2);
    }
    .qTitle{
      margin: 10px 0 0;
      font-size: 18px;
      font-weight: 850;
      letter-spacing: -0.02em;
      color: rgba(255,255,255,.92);
    }
    .qSub{
      margin: 8px 0 0;
      font-size: 13px;
      line-height: 1.55;
      color: var(--muted);
      max-width: 70ch;
    }

    .options{
      padding: 16px 18px 18px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 740px){
      .options{ grid-template-columns: 1fr; }
    }

    .opt{
      min-height: var(--tap);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 14px;
      display:flex;
      align-items:flex-start;
      gap: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .opt:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .opt:active{ transform: scale(.99); }
    .opt.selected{
      background: linear-gradient(135deg, rgba(155,246,255,.14), rgba(199,249,204,.08));
      border-color: rgba(155,246,255,.22);
    }
    .ico{
      width: 42px; height: 42px;
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .optMain{ min-width:0; }
    .optLabel{
      font-weight: 850;
      color: rgba(255,255,255,.90);
      font-size: 14px;
      line-height: 1.25;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .optHint{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .tag{
      font-size: 11px;
      color: rgba(255,255,255,.55);
      white-space:nowrap;
    }

    .navRow{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .navRow .status{
      font-size: 12px;
      color: var(--muted2);
    }

    .side{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .sideHeader{
      padding: 16px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .sideBody{ padding: 16px 18px 18px; }

    .field{
      margin-top: 12px;
    }
    .field label{
      display:block;
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted2);
      margin-bottom: 7px;
    }
    .input, .textarea{
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.88);
      padding: 12px 14px;
      outline:none;
      font-size: 14px;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    .textarea{ min-height: 110px; resize: vertical; }
    .input:focus, .textarea:focus{
      border-color: rgba(155,246,255,.28);
      box-shadow: 0 0 0 4px rgba(155,246,255,.08);
    }
    .input::placeholder, .textarea::placeholder{ color: rgba(255,255,255,.33); }

    /* Welcome */
    .welcome{
      display:grid;
      place-items:center;
      min-height: calc(100vh - 140px);
      padding: 18px 0 80px;
    }
    .welcomeCard{
      width: min(720px, 100%);
      border-radius: 32px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .welcomeHero{
      height: 220px;
      background:
        radial-gradient(900px 320px at 15% 10%, rgba(155,246,255,.18), transparent 62%),
        radial-gradient(900px 320px at 80% 10%, rgba(189,178,255,.18), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .welcomeBody{ padding: 18px; }
    .welcomeTitle{
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.02em;
      font-weight: 900;
      color: rgba(255,255,255,.94);
    }
    .welcomeText{
      margin: 10px 0 0;
      font-size: 15px;
      line-height: 1.6;
      color: var(--muted);
      max-width: 70ch;
    }
    .welcomeActions{
      margin-top: 16px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }

    /* Result */
    .resultHero{
      position:relative;
      height: 320px;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(155,246,255,.14), transparent 60%),
        radial-gradient(900px 320px at 80% 10%, rgba(199,249,204,.12), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .resultHero.hasImg{
      background-size: cover;
      background-position:center;
    }
    .resultShade{
      position:absolute; inset:0;
      background: linear-gradient(180deg, transparent 0%, rgba(11,15,20,.35) 45%, rgba(11,15,20,.90) 100%);
    }
    .resultOverlay{
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding: 18px;
      gap: 10px;
    }
    .resultTitle{
      margin:0;
      font-size: 30px;
      letter-spacing: -0.02em;
      font-weight: 900;
      color: rgba(255,255,255,.96);
    }
    .resultHeadline{
      margin:0;
      font-size: 15px;
      line-height: 1.55;
      color: rgba(255,255,255,.72);
      max-width: 78ch;
    }

    .moodGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      padding: 16px 18px 0;
    }
    @media (max-width: 980px){
      .moodGrid{ grid-template-columns: 1fr; }
    }

    .pcard{
      border-radius: 26px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .pcHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pcChip{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 850;
      color: rgba(255,255,255,.76);
    }
    .pcBody{ padding: 14px; }
    .pcBody .t{
      font-weight: 900;
      font-size: 16px;
      color: rgba(255,255,255,.92);
      letter-spacing: -0.01em;
      margin:0;
    }
    .pcBody .s{
      margin: 10px 0 0;
      font-size: 13px;
      line-height: 1.55;
      color: var(--muted);
    }
    .pcBody .m{
      margin: 10px 0 0;
      font-size: 12px;
      line-height: 1.55;
      color: var(--muted2);
    }

    .resultLower{
      padding: 16px 18px 18px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .resultLower{ grid-template-columns: 1fr; }
    }

    .box{
      border-radius: 26px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
    }
    .box h3{
      margin:0;
      font-size: 12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: var(--muted2);
    }
    .box ul{
      margin: 12px 0 0;
      padding: 0 0 0 18px;
      color: rgba(255,255,255,.74);
      font-size: 13px;
      line-height: 1.6;
    }
    .box p{
      margin: 12px 0 0;
      color: rgba(255,255,255,.72);
      font-size: 13px;
      line-height: 1.6;
    }
    .note{
      margin-top: 12px;
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }

    .summary{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 980px){
      .summary{ grid-template-columns: 1fr; }
    }
    .summaryItem{
      border-radius: 18px;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.72);
      font-size: 13px;
      line-height: 1.45;
    }

    /* Sticky footer */
    .sticky{
      position:fixed;
      left:0; right:0; bottom:0;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(12px);
      padding-bottom: env(safe-area-inset-bottom);
      z-index: 20;
    }
    .stickyInner{
      max-width: var(--max);
      margin: 0 auto;
      padding: 10px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .stickyLeft{
      color: var(--muted);
      font-size: 13px;
    }
    .stickyLeft strong{ color: rgba(255,255,255,.86); }
    .stickyBtns{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .toast{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 50;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.85);
      font-size: 13px;
      box-shadow: var(--shadow2);
      opacity: 0;
      transform: translateY(-8px);
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
      max-width: min(420px, calc(100vw - 32px));
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }

    .hidden{ display:none !important; }

    /* Small helper */
    .mutedLine{
      margin-top: 12px;
      border-radius: 22px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <small>İntema</small>
          <strong>Müşteri Analiz Asistanı</strong>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="savedPill">Kayıtlı teklif: <b id="savedCount" style="color:rgba(255,255,255,.86);">0</b></div>
        <button class="btn" id="resetBtn" type="button">Sıfırla</button>
      </div>
    </div>

    <!-- WELCOME -->
    <section class="welcome" id="screenWelcome">
      <div class="welcomeCard">
        <div class="welcomeHero"></div>
        <div class="welcomeBody">
          <h1 class="welcomeTitle">Müşteri Analiz Asistanı</h1>
          <p class="welcomeText">
            Showroom’da müşteriyi hızlı profille. Cevaplara göre persona çıkar, model ve aksesuar önerisini moodboard gibi sun.
            Tie-break kuralı: önce Bütçe (Q13), sonra Stil (Q7).
          </p>

          <div class="welcomeActions">
            <button class="btn primary" id="startBtn" type="button" style="height:46px;padding:0 18px;border-radius:18px;">Analize Başla</button>
            <button class="btn" id="demoBtn" type="button" style="height:46px;padding:0 18px;border-radius:18px;">Demo Doldur</button>
          </div>

          <div class="mutedLine">
            İpucu: Hero görselleri eklemek istersen <code>public/hero</code> gibi bir klasörde lokal görsel kullanıp mapping’te yolu tanımlayabilirsin.
            Görsel yoksa sistem otomatik gradient ile çalışır.
          </div>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section class="grid hidden" id="screenQuiz">
      <div class="card">
        <div class="cardHeader">
          <div class="progressRow">
            <div>
              <div class="kicker">Question Flow</div>
              <div class="h1">Kart seçimleri ile ilerle</div>
              <p class="sub">Q4 çoklu seçim. Sonuç sayfası moodboard formatında.</p>
            </div>

            <div class="progress">
              <div class="progressTop">
                <span>İlerleme</span>
                <span id="progressPct">0%</span>
              </div>
              <div class="bar"><div id="progressBar"></div></div>
            </div>
          </div>

          <div class="chips" id="triggerChips"></div>
        </div>

        <div class="cardBody">
          <div class="qMeta">
            <div><strong id="qCount">Soru 1</strong> <span id="qTotal">/ 13</span></div>
            <div class="qid" id="qId">Q1</div>
          </div>

          <div class="qCard">
            <div class="qHead">
              <div class="qType" id="qType">Tek seçim</div>
              <div class="qTitle" id="qTitle">-</div>
              <div class="qSub" id="qSub">-</div>
            </div>
            <div class="options" id="options"></div>
          </div>

          <div class="navRow">
            <button class="btn" id="backBtn" type="button">Geri</button>
            <div class="status" id="navStatus">Seçim yap</div>
            <button class="btn primary" id="nextBtn" type="button">Devam</button>
          </div>

          <div class="mutedLine" id="winnerPreviewLine">
            Winner preview: <b id="winnerPreview">-</b>
            <span style="color:rgba(255,255,255,.35)"> | </span>
            Tie-break: Bütçe <span id="tbBudget">yok</span>, Stil <span id="tbStyle">yok</span>
          </div>
        </div>
      </div>

      <aside class="side">
        <div class="sideHeader">
          <div class="kicker">Müşteri</div>
          <div class="h1" style="margin-top:8px;font-size:18px;">Profil Bilgileri</div>
          <p class="sub" style="margin-top:8px;">İstersen doldur. Teklif dosyasına gömülür.</p>
        </div>
        <div class="sideBody">
          <div class="field">
            <label for="cName">Ad Soyad</label>
            <input class="input" id="cName" placeholder="Örn: Ayşe Yılmaz" />
          </div>
          <div class="field">
            <label for="cPhone">Telefon</label>
            <input class="input" id="cPhone" placeholder="Örn: +90 5xx xxx xx xx" />
          </div>
          <div class="field">
            <label for="cCity">Şehir / Bölge</label>
            <input class="input" id="cCity" placeholder="Örn: İstanbul, Ataşehir" />
          </div>
          <div class="field">
            <label for="cNote">Not</label>
            <textarea class="textarea" id="cNote" placeholder="Örn: Ada istiyor, evcil hayvan var, hızlı teslimat önemli"></textarea>
          </div>

          <div class="mutedLine" style="margin-top:14px;">
            Anlık sonuç: <b id="livePersona">-</b><br/>
            <span style="color:rgba(255,255,255,.62);" id="liveHeadline">-</span>
          </div>
        </div>
      </aside>
    </section>

    <!-- RESULT -->
    <section class="grid hidden" id="screenResult">
      <div class="card" id="resultCard">
        <div class="resultHero" id="resultHero">
          <div class="resultShade"></div>
          <div class="resultOverlay">
            <div class="chip" style="align-self:flex-start;">Persona</div>
            <h2 class="resultTitle" id="rTitle">-</h2>
            <p class="resultHeadline" id="rHeadline">-</p>
            <div class="chips" id="rChips"></div>
          </div>
        </div>

        <div class="moodGrid" id="productCards"></div>

        <div class="resultLower">
          <div class="box">
            <h3>Kritik Özellikler</h3>
            <ul id="rFeatures"></ul>

            <div class="note">
              <h3 style="margin:0;font-size:12px;letter-spacing:.22em;text-transform:uppercase;color:rgba(255,255,255,.55);">Mimar Notu</h3>
              <p id="rArchitectNote" style="margin-top:10px;">-</p>

              <div id="rPetBox" class="note hidden" style="margin-top:12px;border-color:rgba(16,185,129,.22);background:rgba(16,185,129,.10);">
                <div style="font-weight:900;color:rgba(209,250,229,.92);">PET önerisi</div>
                <div style="margin-top:6px;color:rgba(255,255,255,.72);font-size:13px;line-height:1.6;">
                  Temizlik ve leke hassasiyeti geldi. Anti-fingerprint ve çizik dayanımı mesajını öne çıkar.
                </div>
              </div>
            </div>
          </div>

          <div class="box">
            <h3>Teklif Bilgisi</h3>
            <p style="margin-top:12px;">
              <b id="rSalesTip">-</b>
            </p>

            <div class="note">
              <h3 style="margin:0;font-size:12px;letter-spacing:.22em;text-transform:uppercase;color:rgba(255,255,255,.55);">Tie-break</h3>
              <p id="rTieBreak" style="margin-top:10px;">-</p>
            </div>

            <div class="note">
              <h3 style="margin:0;font-size:12px;letter-spacing:.22em;text-transform:uppercase;color:rgba(255,255,255,.55);">Seçim Özeti</h3>
              <div class="summary" id="rSummary"></div>
            </div>
          </div>
        </div>
      </div>

      <aside class="side">
        <div class="sideHeader">
          <div class="kicker">Teklif</div>
          <div class="h1" style="margin-top:8px;font-size:18px;">Kaydet / CRM</div>
          <p class="sub" style="margin-top:8px;">Teklif JSON olarak indirilebilir. CRM butonu JSON’u kopyalar.</p>
        </div>
        <div class="sideBody">
          <div class="mutedLine" style="margin-top:0;">
            Müşteri: <b id="rCustomerName">-</b><br/>
            Telefon: <span id="rCustomerPhone">-</span><br/>
            Bölge: <span id="rCustomerCity">-</span>
          </div>

          <div class="mutedLine">
            Not:<br/>
            <span id="rCustomerNote">-</span>
          </div>

          <button class="btn" id="editBtn" type="button" style="width:100%;height:46px;border-radius:18px;margin-top:12px;">Cevapları Düzenle</button>
          <button class="btn" id="newBtn" type="button" style="width:100%;height:46px;border-radius:18px;margin-top:10px;">Yeni Analiz</button>
        </div>
      </aside>
    </section>
  </div>

  <div class="sticky hidden" id="sticky">
    <div class="stickyInner">
      <div class="stickyLeft">
        <strong>Showroom Tool</strong> <span style="color:rgba(255,255,255,.35)">|</span> iPad uyumlu moodboard teklif
      </div>
      <div class="stickyBtns">
        <button class="btn" id="crmBtn" type="button">CRM’ye Gönder</button>
        <button class="btn primary" id="saveBtn" type="button">Teklifi Kaydet</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // DATA: Personas + Mapping
    // -----------------------------
    const PERSONA_ORDER = ["tech","luxury","comfort","smart","gourmet","eco","social","coastal","quick","nostalgic"];

    const PERSONA_DB = {
      tech: {
        titleTR: "Teknoloji Tutkunu Vizyoner",
        headline: "Mutfak Değil, Bir Teknoloji Üssü.",
        heroImage: "", // optional local path e.g. "hero/inova.jpg"
        products: [
          { kind:"Model", title:"INOVA (Handle-less)", subtitle:"Kulpsuz, net çizgiler, modern dil", meta:"" },
          { kind:"Material", title:"Mat Lake", subtitle:"Koyu Taupe / Antrasit", meta:"Low-glare, güçlü kontrast" },
          { kind:"Accessory", title:"Ring Prizli Aydınlatma Ünitesi", subtitle:"USB Charging", meta:"Teknoloji hissi + pratiklik" },
        ],
        features: [
          "Kulpsuz çizgi ve net geometriler",
          "Yüksek kontrast, düşük parlamalı yüzey",
          "Akıllı aksesuarlarla kullanım ritmi",
          "Tezgah ergonomisi ve istasyon düzeni",
        ],
        salesTip: "+5cm ekstra tezgah yüksekliğini özellikle vurgula."
      },
      luxury: {
        titleTR: "Klasik Lüks Sever",
        headline: "Zamanın Ötesinde Bir Prestij.",
        heroImage: "",
        products: [
          { kind:"Model", title:"TOSCANA (Framed doors)", subtitle:"Çerçeveli kapak, prestij hissi", meta:"" },
          { kind:"Material", title:"Parlak Lake", subtitle:"Porselen Mavi", meta:"Güçlü yüzey kalitesi" },
          { kind:"Accessory", title:"Tezgah Üstü Büfe Dolaplar", subtitle:"Glass cabinets", meta:"Sergileme ve servis" },
        ],
        features: [
          "Klasik oranlar, çerçeveli kapak dili",
          "Parlak lake ile güçlü premium algı",
          "Vitrin ve büfe ile sergileme etkisi",
          "Detaylarda yüksek işçilik hissi",
        ],
        salesTip: "Prestij dilini üç kelimeyle kilitle: oran, yüzey, detay."
      },
      comfort: {
        titleTR: "Konfor Odaklı Aile",
        headline: "Hayatın Hızına Yetişen Dayanıklı Mutfak.",
        heroImage: "",
        products: [
          { kind:"Model", title:"SIENA veya NORDA", subtitle:"Aile rutini için dayanım", meta:"" },
          { kind:"Material", title:"Akrilik PET", subtitle:"Anti-fingerprint, Scratch-resistant", meta:"Hijyen + bakım kolaylığı" },
          { kind:"Accessory", title:"Boy Kiler Mekanizması (Pantry) & Pet Module", subtitle:"Düzen + evcil senaryosu", meta:"Günlük akış kolaylaşır" },
        ],
        features: [
          "Kolay temizlenen, iz tutmayan yüzey",
          "Çizik ve leke toleransı yüksek yapı",
          "Pantry ile düzen ve hızlı erişim",
          "Evcil/çocuk senaryosuna uygun akış",
        ],
        salesTip: "Müşteriye günlük rutini anlat: temizlik, düzen, hijyen, hız."
      },
      smart: {
        titleTR: "Akıllı Yatırımcı (Micro-Living)",
        headline: "Akıllı Metrekareler, Yüksek Değer.",
        heroImage: "",
        products: [
          { kind:"Model", title:"PRIME (Budget-friendly)", subtitle:"Net bütçe kontrolü", meta:"" },
          { kind:"Material", title:"Melamin", subtitle:"Sıcak Beyaz / Bej", meta:"Dayanım + maliyet dengesi" },
          { kind:"Accessory", title:"Açılır Masa Mekanizması", subtitle:"Space saving", meta:"Küçük alanda büyük etki" },
        ],
        features: [
          "Metrekare verimliliği ve hızlı kurulum",
          "Maliyet kontrolü ve dengeli malzeme",
          "Katlanır/çok amaçlı kullanım",
          "Yatırım senaryosunda risksiz seçim",
        ],
        salesTip: "Rakam odaklı konuş: teslim süresi, maliyet, dayanım, değer."
      },
      gourmet: {
        titleTR: "Gurme Şef",
        headline: "Evinizin Profesyonel Lezzet İstasyonu.",
        heroImage: "",
        products: [
          { kind:"Model", title:"INOVA (High capacity)", subtitle:"Güçlü depolama, istasyon mantığı", meta:"" },
          { kind:"Material", title:"Soft Lak veya Metal Look", subtitle:"Grafit", meta:"Profesyonel, kontrollü görünüm" },
          { kind:"Accessory", title:"Ergonomik Bulaşık Makinesi Ünitesi & Drawer Organizers", subtitle:"Akış ve düzen", meta:"Daha az eğilme, daha hızlı servis" },
        ],
        features: [
          "Pişirme hattı ve istasyon düzeni",
          "Organizer ile dağınıklığı bitiren kurgu",
          "Ergonomi: daha az eğilme, daha hızlı akış",
          "Yüksek kapasite depolama ve erişim",
        ],
        salesTip: "Müşteriye mutfakta yaptığı hareketleri adım adım anlattır, ona göre planı bağla."
      },
      eco: {
        titleTR: "Doğal Yaşam Savunucusu",
        headline: "Doğanın Huzuru Mutfağınızda.",
        heroImage: "",
        products: [
          { kind:"Model", title:"NORDA (Scandinavian)", subtitle:"Sakin, doğal çizgi", meta:"" },
          { kind:"Material", title:"Natural Wood Veneer & Recycled Mat PET", subtitle:"Sürdürülebilir yüzey dili", meta:"Doğal doku + sorumlu seçim" },
          { kind:"Accessory", title:"Micro Garden Ünitesi", subtitle:"Grow herbs", meta:"Yaşayan mutfak hissi" },
        ],
        features: [
          "Doğal doku ve yumuşak ton dengesi",
          "Sürdürülebilir malzeme vurgusu",
          "Herb garden ile yaşayan mutfak hissi",
          "Sade, dingin, zamansız görünüm",
        ],
        salesTip: "Sürdürülebilirlik mesajını ürün davranışıyla bağla: bakım, ömür, günlük kullanım."
      },
      social: {
        titleTR: "Sosyal Ev Sahibi",
        headline: "Sadece Yemek Değil, Sohbet Pişirilen Yer.",
        heroImage: "",
        products: [
          { kind:"Model", title:"INOVA (Island Layout)", subtitle:"Ada etrafında sosyal akış", meta:"" },
          { kind:"Material", title:"Contrast Colors", subtitle:"Walnut & Cashmere", meta:"Kontrastla sahne etkisi" },
          { kind:"Accessory", title:"Wine/Glass Modules & Metal Open Shelves", subtitle:"Sergileme + servis", meta:"Misafir senaryosu" },
        ],
        features: [
          "Ada ile sosyal akış ve servis hattı",
          "Sergileme ve vitrin etkisi",
          "Kontrast materyal ile sahne hissi",
          "Misafir senaryosuna uygun depolama",
        ],
        salesTip: "Müşteriye bir akşam yemeği senaryosu çiz: servis, sohbet, hazırlık, toparlama."
      },
      coastal: {
        titleTR: "Dinginlik Arayan (Yazlık)",
        headline: "Her Gün Tatil Sabahına Uyanmak Gibi.",
        heroImage: "",
        products: [
          { kind:"Model", title:"FRESCA (Vertical grooves)", subtitle:"Dikey oluklarla hafif ritim", meta:"" },
          { kind:"Material", title:"Mat PET", subtitle:"Ocean Blue / Sage Green", meta:"Ferahlık ve yumuşak ton" },
          { kind:"Accessory", title:"Under-window Sink Layout & Wicker Baskets", subtitle:"Ritüel ve düzen", meta:"Pencere önü hissi" },
        ],
        features: [
          "Ferahlık veren ton paleti",
          "Dikey doku ile sakin ritim",
          "Pencere önü ritüeli ve doğal aksesuar",
          "Yazlık kullanımında kolay bakım",
        ],
        salesTip: "Huzur hissini ışık ve renk üzerinden anlat, müşterinin zihninde sabah sahnesi kur."
      },
      quick: {
        titleTR: "Hız ve Pratiklik Odaklı",
        headline: "Beklemeden Yeni Mutfağınıza Kavuşun.",
        heroImage: "",
        products: [
          { kind:"Model", title:"PRIME (Stock)", subtitle:"Hazır sistem, düşük risk", meta:"" },
          { kind:"Material", title:"Laminate Countertop", subtitle:"3-week delivery", meta:"Hız odaklı paket" },
          { kind:"Accessory", title:"Rail Accessory Sets", subtitle:"No drilling", meta:"Hızlı düzen, hızlı kullanım" },
        ],
        features: [
          "Stok sistem ile hız",
          "Kurulum ve teslimatta pratiklik",
          "Delmeden aksesuarla hızlı düzen",
          "Risk azaltan standart çözüm",
        ],
        salesTip: "Süreyi netleştir: ölçü, onay, üretim/teslim, kurulum. Müşteri bunu duymak ister."
      },
      nostalgic: {
        titleTR: "Nostaljik Romantik",
        headline: "Geçmişin Sıcaklığı, Bugünün Konforu.",
        heroImage: "",
        products: [
          { kind:"Model", title:"VEGA (Country/Vintage)", subtitle:"Duygusal bağ kuran çizgi", meta:"" },
          { kind:"Material", title:"Polymeric", subtitle:"Magnolia / Baltic Blue", meta:"Sıcak ve davetkar tonlar" },
          { kind:"Accessory", title:"Rustic Brass Handles", subtitle:"Rustik pirinç kulplar", meta:"Karakteri kulp taşır" },
        ],
        features: [
          "Country oranlar ve sıcak detay dili",
          "Tonlarla duygu ve ev hissi",
          "Pirinç kulplarla güçlü karakter",
          "Vintage çizgide modern konfor",
        ],
        salesTip: "Müşterinin anılarına bağlan: aile masası, pazar kahvaltısı, koku ve doku."
      }
    };

    // -----------------------------
    // DATA: Questions (Q4 multi)
    // Full set Q1-Q13 (Q8-Q12 included)
    // Tie-break: Q13 then Q7
    // -----------------------------
    const QUESTIONS = [
      {
        id:"q1", label:"Q1", type:"single",
        title:"Proje niteliği nedir?",
        subtitle:"Müşterinin ana bağlamı: yeni ev mi, yatırım mı, yazlık mı?",
        options:[
          { id:"newHouse", label:"Yeni Ev / Sıfır Proje", desc:"Yeni taşınma veya yeni inşaat.", icon:"home", points:{ tech:5, luxury:5 } },
          { id:"investment", label:"Yatırım / Stüdyo", desc:"Kiralık veya satış odaklı.", icon:"home", points:{ smart:20 } },
          { id:"summer", label:"Yazlık", desc:"Sahil, sezonluk kullanım.", icon:"home", points:{ coastal:20 } }
        ]
      },
      {
        id:"q2", label:"Q2", type:"single",
        title:"Zaman kısıtı var mı?",
        subtitle:"Teslimat ve karar hızını ölçer.",
        options:[
          { id:"urgent", label:"Acil", desc:"Hızlı karar, hızlı uygulama.", icon:"clock", points:{ quick:20, smart:10 } },
          { id:"perfectionist", label:"Acele yok, mükemmeliyetçi", desc:"Detay odaklı, kusursuzluk arar.", icon:"clock", points:{ luxury:10, nostalgic:5 } }
        ]
      },
      {
        id:"q3", label:"Q3", type:"single",
        title:"Alan durumu nasıl?",
        subtitle:"Metrekare ve plan, öneri tipini değiştirir.",
        options:[
          { id:"small", label:"Küçük / Dar", desc:"Verimlilik ve kompakt çözümler.", icon:"area", points:{ smart:10 } },
          { id:"large", label:"Geniş / Ada mümkün", desc:"Sosyal akış ve güçlü pişirme hattı.", icon:"area", points:{ social:15, gourmet:10 } }
        ]
      },
      {
        id:"q4", label:"Q4", type:"multi",
        title:"Hane halkı hangilerine uyuyor?",
        subtitle:"Çoklu seçim. Çocuk + Evcil hayvan seçilirse High Durability Alert tetikler.",
        options:[
          { id:"singleCouple", label:"Tek kişi / Çift", desc:"Minimal düzen, teknolojiye açık.", icon:"users", points:{ tech:10 } },
          { id:"children", label:"Çocuk", desc:"Dayanım, hijyen, güvenlik.", icon:"users", points:{ comfort:15 } },
          { id:"pets", label:"Evcil hayvan", desc:"Sürdürülebilirlik ve kolay bakım.", icon:"users", points:{ eco:10 } }
        ]
      },
      {
        id:"q5", label:"Q5", type:"single",
        title:"Ana motivasyon ne?",
        subtitle:"Mutfak, müşterinin hayatında neyi temsil ediyor?",
        options:[
          { id:"showcase", label:"Showcase / Sosyal", desc:"Misafir, sunum, eğlence.", icon:"spark", points:{ social:20 } },
          { id:"operation", label:"Operasyon / Pişirme", desc:"Fonksiyon, istasyon mantığı.", icon:"spark", points:{ gourmet:20 } },
          { id:"sanctuary", label:"Sanctuary / Huzur", desc:"Sakinlik, doğal his.", icon:"spark", points:{ coastal:15, eco:10 } },
          { id:"heart", label:"Heart / Aile", desc:"Rutinler, dayanım, sıcaklık.", icon:"spark", points:{ comfort:15, nostalgic:10 } }
        ]
      },
      {
        id:"q6", label:"Q6", type:"single",
        title:"En büyük acı noktası ne?",
        subtitle:"Problemi seç, sistem çözümü bağlasın.",
        options:[
          { id:"cleaning", label:"Temizlik / Leke", desc:"Kolay silinebilir, dayanıklı yüzeyler.", icon:"broom", points:{ comfort:20 }, trigger:"petMaterial" },
          { id:"clutter", label:"Dağınıklık", desc:"Organizer ve depolama ihtiyacı.", icon:"broom", points:{ gourmet:10 } },
          { id:"outdated", label:"Eski görünüm", desc:"Modernleşme isteği.", icon:"broom", points:{ tech:10 } }
        ]
      },
      {
        id:"q7", label:"Q7", type:"single",
        title:"Tasarım dili hangisi?",
        subtitle:"Tie-break için kritik (2. öncelik).",
        options:[
          { id:"modern", label:"Modern / Minimal", desc:"Kulpsuz, net çizgiler.", icon:"style", points:{ tech:20 } },
          { id:"classic", label:"Klasik / Grand", desc:"Çerçeveli kapak, prestij.", icon:"style", points:{ luxury:20 } },
          { id:"country", label:"Country / Natural", desc:"Ahşap dokular, sıcaklık.", icon:"style", points:{ eco:15, nostalgic:15 } },
          { id:"industrial", label:"Industrial", desc:"Kontrast, metal hissi.", icon:"style", points:{ tech:10 } }
        ]
      },

      // Added from original 13-question set
      {
        id:"q8", label:"Q8", type:"single",
        title:"Malzeme hissi hangisi?",
        subtitle:"Yüzey ve dokunun karakterini seç.",
        options:[
          { id:"wood", label:"Ahşap", desc:"Doğal doku ve sıcaklık.", icon:"material", points:{ eco:20 } },
          { id:"matsoft", label:"Mat / Soft", desc:"Yumuşak, sakin yüzey.", icon:"material", points:{ comfort:10 } },
          { id:"gloss", label:"Yüksek parlak", desc:"Gösterişli ve premium algı.", icon:"material", points:{ luxury:15 } },
          { id:"dark", label:"Koyu ton", desc:"Kontrast ve modern güç.", icon:"material", points:{ tech:15 } }
        ]
      },
      {
        id:"q9", label:"Q9", type:"single",
        title:"Pişirme yaklaşımı nasıl?",
        subtitle:"Kullanım yoğunluğu öneriyi değiştirir.",
        options:[
          { id:"gourmet", label:"Gurme", desc:"Sık pişirir, ekipman kullanır.", icon:"cook", points:{ gourmet:25 } },
          { id:"practical", label:"Pratik", desc:"Hız, basit rutinler.", icon:"cook", points:{ smart:10 } }
        ]
      },
      {
        id:"q10", label:"Q10", type:"single",
        title:"Depolamada öncelik ne?",
        subtitle:"Düzen ve sergileme tercihleri.",
        options:[
          { id:"pantry", label:"Kiler / Pantry", desc:"Gizli düzen, hızlı erişim.", icon:"storage", points:{ comfort:10 } },
          { id:"vitrine", label:"Vitrin / Sergileme", desc:"Görsel etki ve sunum.", icon:"storage", points:{ social:15 } }
        ]
      },
      {
        id:"q11", label:"Q11", type:"single",
        title:"Sürdürülebilirlik önemi ne kadar?",
        subtitle:"Malzeme ve seçim önceliği.",
        options:[
          { id:"high", label:"Yüksek", desc:"Sürdürülebilir seçim çok önemli.", icon:"leaf", points:{ eco:25 } },
          { id:"normal", label:"Normal", desc:"Denge önemli.", icon:"leaf", points:{} }
        ]
      },
      {
        id:"q12", label:"Q12", type:"single",
        title:"Teknoloji yaklaşımı nasıl?",
        subtitle:"Akıllı çözümler mi, geleneksel mi?",
        options:[
          { id:"hightech", label:"High-Tech", desc:"Entegre, akıllı aksesuarlar.", icon:"chip", points:{ tech:20 } },
          { id:"traditional", label:"Geleneksel", desc:"Klasik kullanım, sıcak his.", icon:"chip", points:{ nostalgic:15 } }
        ]
      },
      {
        id:"q13", label:"Q13", type:"single",
        title:"Bütçe yaklaşımı nasıl?",
        subtitle:"Tie-break için kritik (1. öncelik).",
        options:[
          { id:"flexible", label:"Esnek / Prestij", desc:"Premium kararlar.", icon:"wallet", points:{ luxury:20 } },
          { id:"pp", label:"Fiyat / Performans", desc:"Dengeli seçim.", icon:"wallet", points:{ comfort:10 } },
          { id:"economic", label:"Ekonomik", desc:"Net bütçe, verim.", icon:"wallet", points:{ smart:15 } }
        ]
      }
    ];

    // -----------------------------
    // UI: icons (inline SVG)
    // -----------------------------
    function iconSVG(name){
      const cls = 'width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"';
      switch(name){
        case "home":
          return `<svg ${cls}><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.5Z"/></svg>`;
        case "clock":
          return `<svg ${cls}><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`;
        case "area":
          return `<svg ${cls}><rect x="4" y="4" width="16" height="16" rx="3"/><path d="M8 8h8v8H8z"/></svg>`;
        case "users":
          return `<svg ${cls}><circle cx="12" cy="10" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>`;
        case "spark":
          return `<svg ${cls}><path d="M12 2l1.4 5.2L18 9l-4.6 1.8L12 16l-1.4-5.2L6 9l4.6-1.8L12 2Z"/><path d="M19 13l.8 2.8L22 17l-2.2.8L19 20l-.8-2.2L16 17l2.2-1.2L19 13Z"/></svg>`;
        case "broom":
          return `<svg ${cls}><path d="M14 3l7 7"/><path d="M3 21l8-8"/><path d="M11 13l3 3"/><path d="M12 12c2.5-2.5 6-3 9-1"/></svg>`;
        case "style":
          return `<svg ${cls}><path d="M4 6h16"/><path d="M4 12h10"/><path d="M4 18h16"/></svg>`;
        case "wallet":
          return `<svg ${cls}><path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v1H6a2 2 0 0 0-2 2v9a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-9H6"/><path d="M17 14h3"/></svg>`;
        case "leaf":
          return `<svg ${cls}><path d="M20 3c-7 1-12 6-13 13 7-1 12-6 13-13Z"/><path d="M7 16c-2 1-3 3-3 5 2 0 4-1 5-3"/></svg>`;
        case "chip":
          return `<svg ${cls}><rect x="7" y="7" width="10" height="10" rx="2"/><path d="M9 1v4M15 1v4M9 19v4M15 19v4M1 9h4M1 15h4M19 9h4M19 15h4"/></svg>`;
        case "cook":
          return `<svg ${cls}><path d="M8 6c0-2 1.5-3 3-3s3 1 3 3"/><path d="M6 10h12"/><path d="M7 10v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V10"/><path d="M9 14h6"/></svg>`;
        case "storage":
          return `<svg ${cls}><rect x="4" y="6" width="16" height="14" rx="2"/><path d="M8 6V4h8v2"/><path d="M9 12h6"/></svg>`;
        case "material":
          return `<svg ${cls}><path d="M12 2l8 6v8l-8 6-8-6V8l8-6Z"/><path d="M12 2v20"/><path d="M4 8l8 6 8-6"/></svg>`;
        default:
          return `<svg ${cls}><circle cx="12" cy="12" r="9"/></svg>`;
      }
    }

    // -----------------------------
    // State
    // -----------------------------
    const STATE = {
      screen: "welcome", // welcome | quiz | result
      index: 0,
      answers: {}, // qid -> string or string[]
      customer: { name:"", phone:"", city:"", note:"" }
    };

    const STORAGE_KEY = "intema_proposals_v1";

    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("show"), 1600);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function getSavedCount(){
      try{
        const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        return Array.isArray(arr) ? arr.length : 0;
      }catch(e){ return 0; }
    }

    function updateSavedPill(){
      $("savedCount").textContent = String(getSavedCount());
    }

    function safeJSON(obj){
      return JSON.stringify(obj, null, 2);
    }

    function downloadJSON(payload){
      const blob = new Blob([safeJSON(payload)], { type:"application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const base = (payload.customer?.name || "musteri")
        .toLowerCase()
        .replaceAll("ı","i").replaceAll("ğ","g").replaceAll("ü","u")
        .replaceAll("ş","s").replaceAll("ö","o").replaceAll("ç","c")
        .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")
        .slice(0,42) || "musteri";
      a.href = url;
      a.download = `intema-proposal-${base}-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function saveLocal(payload){
      try{
        const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        const list = Array.isArray(arr) ? arr : [];
        list.unshift(payload);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        updateSavedPill();
        return list.length;
      }catch(e){
        return 0;
      }
    }

    function selectionsReadable(answers){
      const out = [];
      for(const q of QUESTIONS){
        const a = answers[q.id];
        if(!a) continue;
        if(Array.isArray(a)){
          const labels = a.map(id => (q.options.find(o=>o.id===id)||{}).label).filter(Boolean);
          if(labels.length) out.push(`${q.title} -> ${labels.join(", ")}`);
        }else{
          const label = (q.options.find(o=>o.id===a)||{}).label;
          if(label) out.push(`${q.title} -> ${label}`);
        }
      }
      return out;
    }

    // -----------------------------
    // Scoring + Tie-break
    // -----------------------------
    function initScores(){
      const s = {};
      PERSONA_ORDER.forEach(k=>s[k]=0);
      return s;
    }

    function addPoints(scores, points){
      if(!points) return;
      for(const k in points){
        if(scores[k] == null) continue;
        scores[k] += points[k] || 0;
      }
    }

    function calculate(answers){
      const scores = initScores();
      const tieBudget = initScores();
      const tieStyle = initScores();

      const triggers = {
        highDurabilityAlert: false,
        petMaterialRecommendation: false
      };

      for(const q of QUESTIONS){
        const a = answers[q.id];
        if(!a) continue;

        if(q.type === "multi"){
          const arr = Array.isArray(a) ? a : [];
          arr.forEach(optId=>{
            const opt = q.options.find(o=>o.id===optId);
            if(!opt) return;
            addPoints(scores, opt.points);
          });
        }else{
          const opt = q.options.find(o=>o.id===a);
          if(!opt) continue;
          addPoints(scores, opt.points);

          if(q.id === "q13") addPoints(tieBudget, opt.points);
          if(q.id === "q7") addPoints(tieStyle, opt.points);

          if(q.id === "q6" && opt.trigger === "petMaterial"){
            triggers.petMaterialRecommendation = true;
          }
        }
      }

      // Special Q4 logic: Children + Pets => +20 comfort + High Durability Alert
      const q4 = answers.q4;
      const q4arr = Array.isArray(q4) ? q4 : [];
      const hasChildren = q4arr.includes("children");
      const hasPets = q4arr.includes("pets");
      if(hasChildren && hasPets){
        scores.comfort += 20;
        triggers.highDurabilityAlert = true;
      }

      const max = Math.max(...PERSONA_ORDER.map(k=>scores[k]));
      const candidates = PERSONA_ORDER.filter(k=>scores[k]===max);

      let usedBudget = false;
      let usedStyle = false;
      let winner = candidates[0];

      if(candidates.length > 1){
        const bMax = Math.max(...candidates.map(k=>tieBudget[k]));
        const bW = candidates.filter(k=>tieBudget[k]===bMax);
        usedBudget = true;

        if(bW.length === 1){
          winner = bW[0];
        }else{
          const sMax = Math.max(...bW.map(k=>tieStyle[k]));
          const sW = bW.filter(k=>tieStyle[k]===sMax);
          usedStyle = true;

          if(sW.length === 1) winner = sW[0];
          else winner = sW[0]; // stable order
        }
      }

      return { winner, scores, triggers, tieBreak:{ usedBudget, usedStyle } };
    }

    // -----------------------------
    // UI Rendering
    // -----------------------------
    function setScreen(name){
      STATE.screen = name;
      $("screenWelcome").classList.toggle("hidden", name !== "welcome");
      $("screenQuiz").classList.toggle("hidden", name !== "quiz");
      $("screenResult").classList.toggle("hidden", name !== "result");
      $("sticky").classList.toggle("hidden", name !== "result");

      // Reset button is always useful
      $("resetBtn").style.opacity = "1";
    }

    function isAnswered(q, answers){
      const v = answers[q.id];
      if(!v) return false;
      if(Array.isArray(v)) return v.length > 0;
      return String(v).length > 0;
    }

    function renderChips(triggers, targetEl){
      targetEl.innerHTML = "";
      if(triggers.highDurabilityAlert){
        const c = document.createElement("div");
        c.className = "chip warn";
        c.textContent = "High Durability Alert";
        targetEl.appendChild(c);
      }
      if(triggers.petMaterialRecommendation){
        const c = document.createElement("div");
        c.className = "chip ok";
        c.textContent = "PET yüzey önerisi tetiklendi";
        targetEl.appendChild(c);
      }
    }

    function renderQuestion(){
      const q = QUESTIONS[STATE.index];
      const total = QUESTIONS.length;

      $("qCount").textContent = `Soru ${STATE.index + 1}`;
      $("qTotal").textContent = `/ ${total}`;
      $("qId").textContent = q.label;

      $("qType").textContent = q.type === "multi" ? "Çoklu seçim" : "Tek seçim";
      $("qTitle").textContent = q.title;
      $("qSub").textContent = q.subtitle || "";

      const pct = Math.round(((STATE.index + 1) / total) * 100);
      $("progressPct").textContent = `${pct}%`;
      $("progressBar").style.width = `${pct}%`;

      const calc = calculate(STATE.answers);
      $("winnerPreview").textContent = PERSONA_DB[calc.winner].titleTR;
      $("tbBudget").textContent = calc.tieBreak.usedBudget ? "var" : "yok";
      $("tbStyle").textContent = calc.tieBreak.usedStyle ? "var" : "yok";
      $("livePersona").textContent = PERSONA_DB[calc.winner].titleTR;
      $("liveHeadline").textContent = PERSONA_DB[calc.winner].headline;

      renderChips(calc.triggers, $("triggerChips"));

      const selected = STATE.answers[q.id];
      const selectedArr = Array.isArray(selected) ? selected : [];
      const selectedOne = (typeof selected === "string") ? selected : "";

      const optionsEl = $("options");
      optionsEl.innerHTML = "";

      q.options.forEach(opt=>{
        const el = document.createElement("div");
        const isSel = q.type === "multi" ? selectedArr.includes(opt.id) : selectedOne === opt.id;
        el.className = `opt ${isSel ? "selected" : ""}`;
        el.setAttribute("role","button");
        el.setAttribute("tabindex","0");

        el.innerHTML = `
          <div class="ico" aria-hidden="true" style="color:rgba(255,255,255,.75);">
            ${iconSVG(opt.icon)}
          </div>
          <div class="optMain">
            <div class="optLabel">
              <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${opt.label}</span>
              <span class="tag">${isSel ? (q.type==="multi" ? "Seçildi" : "Aktif") : ""}</span>
            </div>
            ${opt.desc ? `<div class="optHint">${opt.desc}</div>` : ""}
          </div>
        `;

        const toggle = ()=>{
          if(q.type === "multi"){
            const arr = Array.isArray(STATE.answers[q.id]) ? [...STATE.answers[q.id]] : [];
            const ix = arr.indexOf(opt.id);
            if(ix >= 0) arr.splice(ix, 1);
            else arr.push(opt.id);
            STATE.answers[q.id] = arr;
          }else{
            STATE.answers[q.id] = opt.id;
          }
          renderQuestion();
          updateNav();
        };

        el.addEventListener("click", toggle);
        el.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggle(); }
        });

        optionsEl.appendChild(el);
      });

      updateNav();
    }

    function updateNav(){
      const q = QUESTIONS[STATE.index];
      const canNext = isAnswered(q, STATE.answers);

      $("backBtn").disabled = STATE.index === 0;
      $("nextBtn").disabled = !canNext;

      const isLast = STATE.index === QUESTIONS.length - 1;
      $("nextBtn").textContent = isLast ? "Sonucu Gör" : "Devam";
      $("navStatus").textContent = canNext ? "Hazır" : "Seçim yap";
    }

    function buildProposal(){
      const calc = calculate(STATE.answers);
      const selections = selectionsReadable(STATE.answers);
      const db = PERSONA_DB[calc.winner];

      return {
        createdAtISO: new Date().toISOString(),
        customer: { ...STATE.customer },
        answers: JSON.parse(JSON.stringify(STATE.answers)),
        selectionsReadable: selections,
        persona: {
          key: calc.winner,
          titleTR: db.titleTR,
          headline: db.headline,
          scores: calc.scores,
          triggers: calc.triggers,
          tieBreak: calc.tieBreak,
          products: db.products,
          features: db.features,
          salesTip: db.salesTip || "Öneriyi 3 cümleyle kilitle: model dili, malzeme hissi, aksesuar farkı."
        }
      };
    }

    function renderResult(){
      const payload = buildProposal();
      const db = PERSONA_DB[payload.persona.key];

      // Hero
      const heroEl = $("resultHero");
      heroEl.classList.remove("hasImg");
      heroEl.style.backgroundImage = "";

      if(db.heroImage){
        heroEl.classList.add("hasImg");
        heroEl.style.backgroundImage = `url('${db.heroImage}')`;
      }

      $("rTitle").textContent = db.titleTR;
      $("rHeadline").textContent = db.headline;

      const chipsEl = $("rChips");
      chipsEl.innerHTML = "";
      renderChips(payload.persona.triggers, chipsEl);

      // Product cards
      const pc = $("productCards");
      pc.innerHTML = "";
      db.products.forEach(p=>{
        const el = document.createElement("div");
        el.className = "pcard";
        el.innerHTML = `
          <div class="pcHead">
            <div class="pcChip">${p.kind === "Model" ? "Önerilen Model" : (p.kind === "Material" ? "Malzeme / Özellik" : "Must-have Aksesuar")}</div>
            <div class="kicker" style="letter-spacing:.18em;">${p.kind}</div>
          </div>
          <div class="pcBody">
            <p class="t">${p.title}</p>
            ${p.subtitle ? `<p class="s">${p.subtitle}</p>` : ""}
            ${p.meta ? `<p class="m">${p.meta}</p>` : ""}
          </div>
        `;
        pc.appendChild(el);
      });

      // Features
      const f = $("rFeatures");
      f.innerHTML = "";
      (db.features || []).forEach(x=>{
        const li = document.createElement("li");
        li.textContent = x;
        f.appendChild(li);
      });

      // Architect note
      const note = buildArchitectNote(payload);
      $("rArchitectNote").textContent = note;

      // Pet box
      $("rPetBox").classList.toggle("hidden", !payload.persona.triggers.petMaterialRecommendation);

      // Sales tip
      $("rSalesTip").textContent = payload.persona.salesTip;

      // Tie break
      $("rTieBreak").textContent =
        `Bütçe: ${payload.persona.tieBreak.usedBudget ? "Kullanıldı" : "Kullanılmadı"} | Stil: ${payload.persona.tieBreak.usedStyle ? "Kullanıldı" : "Kullanılmadı"}`;

      // Summary
      const sum = $("rSummary");
      sum.innerHTML = "";
      payload.selectionsReadable.forEach(s=>{
        const d = document.createElement("div");
        d.className = "summaryItem";
        d.textContent = s;
        sum.appendChild(d);
      });

      // Customer
      $("rCustomerName").textContent = payload.customer.name || "-";
      $("rCustomerPhone").textContent = payload.customer.phone || "-";
      $("rCustomerCity").textContent = payload.customer.city || "-";
      $("rCustomerNote").textContent = payload.customer.note || "-";

      // Attach payload to buttons
      $("saveBtn").onclick = ()=>{
        const p = buildProposal();
        saveLocal(p);
        downloadJSON(p);
        toast("Teklif kaydedildi ve indirildi.");
      };

      $("crmBtn").onclick = async ()=>{
        const p = buildProposal();
        const txt = safeJSON(p);
        try{
          await navigator.clipboard.writeText(txt);
          toast("CRM için JSON kopyalandı.");
        }catch(e){
          window.prompt("Kopyala (Ctrl/Cmd + C):", txt);
        }
      };
    }

    function buildArchitectNote(payload){
      const t = payload.persona.triggers;
      const key = payload.persona.key;

      if(t.highDurabilityAlert){
        return "Çocuk + evcil hayvan senaryosu var. Darbe, çizik ve leke toleransı yüksek yüzeylere git. Akrilik PET ve bakım kolaylığını satışta öne çıkar. Pantry ile düzeni kilitle.";
      }

      if(t.petMaterialRecommendation){
        return "Temizlik ve leke hassasiyeti çıktı. Anti-fingerprint ve hızlı bakım mesajını net kur. Kullanım ritmini basitleştiren organizer ve yüzey seçimiyle kararı hızlandır.";
      }

      if(key === "quick"){
        return "Müşteri hız istiyor. Süreci 4 adıma indir: ölçü, onay, teslim, kurulum. Stok model ve aksesuar setleriyle riski düşür.";
      }

      if(key === "social"){
        return "Sosyal senaryoyu sahnele: ada etrafında servis ve sohbet. Sergileme modülleri ve depolamayı misafir akışına bağla.";
      }

      if(key === "gourmet"){
        return "İstasyon mantığını kur: hazırlık, pişirme, servis, toparlama. Organizer ve ergonomi üzerinden değer yarat.";
      }

      if(key === "luxury"){
        return "Prestij dili: oran, yüzey, detay. Vitrin ve cam büfe ile katmanlı bir kalite hissi oluştur.";
      }

      if(key === "eco"){
        return "Doğallık ve sürdürülebilirliği aynı cümlede bağla: doku, ömür, bakım. Micro garden ile yaşayan mutfak hissini güçlendir.";
      }

      if(key === "coastal"){
        return "Huzur hissini renk, ışık ve ritim üzerinden anlat. Pencere önü senaryosu ve doğal aksesuarlarla anlatıyı tamamla.";
      }

      if(key === "nostalgic"){
        return "Duygusal bağ üzerinden ilerle. Tonlar ve kulp detaylarıyla karakteri belirginleştir. Modern konforu vintage dilin içine göm.";
      }

      // tech or fallback
      return "Öneriyi senaryo ile kilitle: müşterinin günlük ritmi, kullanım kolaylığı ve net fark yaratan aksesuar. Karar noktalarını sadeleştir.";
    }

    // -----------------------------
    // Events
    // -----------------------------
    function syncCustomerFromInputs(){
      STATE.customer.name = $("cName").value.trim();
      STATE.customer.phone = $("cPhone").value.trim();
      STATE.customer.city = $("cCity").value.trim();
      STATE.customer.note = $("cNote").value.trim();
    }

    ["cName","cPhone","cCity","cNote"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        syncCustomerFromInputs();
        if(STATE.screen === "quiz"){
          const calc = calculate(STATE.answers);
          $("livePersona").textContent = PERSONA_DB[calc.winner].titleTR;
          $("liveHeadline").textContent = PERSONA_DB[calc.winner].headline;
        }
      });
    });

    $("startBtn").addEventListener("click", ()=>{
      setScreen("quiz");
      STATE.index = 0;
      renderQuestion();
      toast("Analiz başladı.");
    });

    $("demoBtn").addEventListener("click", ()=>{
      // Quick demo answers to show result
      STATE.answers = {
        q1:"newHouse",
        q2:"urgent",
        q3:"large",
        q4:["children","pets"],
        q5:"operation",
        q6:"cleaning",
        q7:"modern",
        q8:"matsoft",
        q9:"gourmet",
        q10:"pantry",
        q11:"high",
        q12:"hightech",
        q13:"pp"
      };
      setScreen("quiz");
      STATE.index = 0;
      renderQuestion();
      toast("Demo dolduruldu.");
    });

    $("resetBtn").addEventListener("click", ()=>{
      STATE.index = 0;
      STATE.answers = {};
      STATE.customer = { name:"", phone:"", city:"", note:"" };
      $("cName").value = "";
      $("cPhone").value = "";
      $("cCity").value = "";
      $("cNote").value = "";
      setScreen("welcome");
      updateSavedPill();
      toast("Sıfırlandı.");
    });

    $("backBtn").addEventListener("click", ()=>{
      STATE.index = clamp(STATE.index - 1, 0, QUESTIONS.length - 1);
      renderQuestion();
    });

    $("nextBtn").addEventListener("click", ()=>{
      const q = QUESTIONS[STATE.index];
      if(!isAnswered(q, STATE.answers)){
        toast("Devam etmek için seçim yap.");
        return;
      }

      const isLast = STATE.index === QUESTIONS.length - 1;
      if(isLast){
        syncCustomerFromInputs();
        setScreen("result");
        renderResult();
        toast("Sonuç hazır.");
        return;
      }

      STATE.index = clamp(STATE.index + 1, 0, QUESTIONS.length - 1);
      renderQuestion();
    });

    $("editBtn").addEventListener("click", ()=>{
      setScreen("quiz");
      renderQuestion();
      toast("Düzenleme modu.");
    });

    $("newBtn").addEventListener("click", ()=>{
      // keep customer but reset answers by default
      STATE.index = 0;
      STATE.answers = {};
      setScreen("quiz");
      renderQuestion();
      toast("Yeni analiz.");
    });

    // -----------------------------
    // Init
    // -----------------------------
    updateSavedPill();
    setScreen("welcome");
  </script>
</body>
</html>
