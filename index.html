<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>İntema Mutfak Dijital Mimar Asistanı</title>
  <style>
    :root{
      --bg0:#0b0f14;
      --bg1:#0f1620;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --text:#eaf0f7;
      --muted: rgba(234,240,247,.72);
      --muted2: rgba(234,240,247,.54);
      --good: rgba(120,255,180,.18);
      --warn: rgba(255,190,120,.16);
      --bad: rgba(255,120,120,.14);
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 14px;
      --pad: 18px;
      --btn: rgba(255,255,255,.09);
      --btn2: rgba(255,255,255,.13);
      --focus: rgba(140,200,255,.18);
      --maxw: 1020px;
      --tap: 52px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 520px at 80% 0%, rgba(120,200,255,.08), transparent 60%),
        radial-gradient(900px 520px at 70% 95%, rgba(255,220,140,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      padding: 8px 4px 14px;
    }

    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand .kicker{
      font-size:12px;
      color: var(--muted2);
      letter-spacing:.12em;
      text-transform: uppercase;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      line-height:1.25;
      font-weight: 650;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 68ch;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .pill strong{ color: var(--text); font-weight:650; }

    .btn{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: var(--btn);
      color: var(--text);
      font-size: 14px;
      font-weight: 650;
      letter-spacing:.1px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn:hover{ background: var(--btn2); border-color: rgba(255,255,255,.18); }
    .btn:focus{ outline:none; box-shadow: 0 0 0 4px var(--focus); }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }
    .btn.primary{
      background: rgba(140,200,255,.18);
      border-color: rgba(140,200,255,.30);
    }
    .btn.primary:hover{
      background: rgba(140,200,255,.24);
      border-color: rgba(140,200,255,.40);
    }
    .btn.danger{
      background: rgba(255,120,120,.14);
      border-color: rgba(255,120,120,.26);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      header{ align-items:flex-start; }
      .topActions{ justify-content:flex-start; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.045));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px var(--pad);
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
      font-weight: 700;
    }
    .cardHeader .sub{
      margin:0;
      color: var(--muted2);
      font-size: 12px;
      margin-top:2px;
    }
    .cardBody{ padding: var(--pad); }

    .stack{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .fieldRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .fieldRow{ grid-template-columns: 1fr; }
    }

    label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    input[type="text"], input[type="tel"], input[type="email"], textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, textarea:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(140,200,255,.45);
    }
    .hint{
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
      margin-top: 2px;
    }

    .progressWrap{
      padding: 12px var(--pad);
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .progressLeft{
      display:flex;
      flex-direction:column;
      gap: 3px;
    }
    .qMeta{
      color: var(--muted2);
      font-size: 12px;
      letter-spacing:.2px;
    }
    .qText{
      font-size: 18px;
      font-weight: 720;
      margin:0;
      line-height:1.2;
      letter-spacing:.1px;
    }
    .bar{
      width: 260px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      flex: 0 0 auto;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: rgba(140,200,255,.28);
      border-right: 1px solid rgba(140,200,255,.40);
      transition: width .18s ease;
    }
    @media (max-width: 560px){
      .bar{ width: 160px; }
      .qText{ font-size: 16px; }
    }

    .options{
      display:grid;
      gap: 10px;
      margin-top: 14px;
    }
    .opt{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      padding: 14px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      min-height: 56px;
    }
    .opt:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
    .opt:active{ transform: translateY(1px); }
    .opt.sel{
      background: rgba(140,200,255,.16);
      border-color: rgba(140,200,255,.34);
    }
    .opt .t{
      font-size: 15px;
      font-weight: 650;
      line-height:1.25;
    }
    .opt .tag{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted2);
    }
    .opt .mark{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
      margin-top: 2px;
      flex: 0 0 auto;
      position:relative;
    }
    .opt.sel .mark{
      border-color: rgba(140,200,255,.55);
      background: rgba(140,200,255,.22);
    }
    .opt.sel .mark::after{
      content:"";
      position:absolute; inset: 4px;
      border-radius:999px;
      background: rgba(140,200,255,.75);
    }
    .opt.multi .mark{ border-radius: 6px; }
    .opt.multi.sel .mark::after{ border-radius: 4px; }

    .navRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .navRow .left, .navRow .right{
      display:flex; gap:10px; flex-wrap:wrap;
    }

    .mini{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 8px;
      line-height:1.35;
    }

    .resultHero{
      padding: 16px var(--pad);
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .resultTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .badge strong{ color: var(--text); font-weight: 750; }
    .resultTitle{
      margin:0;
      font-size: 20px;
      font-weight: 820;
      letter-spacing:.1px;
      line-height:1.15;
    }
    .resultDesc{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.45;
      max-width: 78ch;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 14px var(--pad);
    }

    .panel{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      padding: 12px 12px;
    }

    .panel h3{
      margin:0 0 8px 0;
      font-size: 13px;
      font-weight: 780;
      letter-spacing:.2px;
    }
    .panel ul{
      margin:0;
      padding-left: 18px;
      color: var(--muted);
      line-height:1.45;
      font-size: 13px;
    }
    .panel p{
      margin:0;
      color: var(--muted);
      line-height:1.45;
      font-size: 13px;
    }

    .alert{
      background: var(--warn);
      border-color: rgba(255,190,120,.32);
    }
    .ok{
      background: var(--good);
      border-color: rgba(120,255,180,.28);
    }

    .toggleRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .seg{
      display:inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background: rgba(255,255,255,.06);
    }
    .seg button{
      height: 40px;
      padding: 0 12px;
      border:0;
      background: transparent;
      color: var(--muted);
      font-weight: 750;
      cursor:pointer;
      letter-spacing:.1px;
    }
    .seg button.on{
      background: rgba(140,200,255,.18);
      color: var(--text);
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    th, td{
      text-align:left;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      color: var(--muted);
    }
    th{
      color: var(--muted2);
      font-weight: 800;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: 11px;
      background: rgba(255,255,255,.04);
    }
    tr:last-child td{ border-bottom: 0; }
    td strong{ color: var(--text); font-weight: 750; }

    .hide{ display:none !important; }

    .footerNote{
      color: var(--muted2);
      font-size: 12px;
      line-height:1.45;
      padding: 10px 4px 0;
    }

    .kbd{
      padding: 3px 7px;
      border-radius: 9px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight: 750;
      font-size: 11px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="kicker">Sales Point Tablet App</div>
        <h1>İntema Mutfak Dijital Mimar Asistanı</h1>
        <p>14 soruluk akış. 10 arketip skoru. Sonuç ekranında reçete, hibrit profil ve mimar modu.</p>
      </div>
      <div class="topActions">
        <div class="pill" id="sessionPill"><strong>Oturum:</strong> <span id="sessionState">Yeni</span></div>
        <button class="btn ghost" id="btnNew">Yeni Görüşme</button>
        <button class="btn danger" id="btnReset">Sıfırla</button>
      </div>
    </header>

    <div class="grid">
      <div class="card" id="mainCard"></div>

      <div class="stack">
        <div class="card">
          <div class="cardHeader">
            <div>
              <h2>Hızlı Kontrol</h2>
              <div class="sub">Mimar için kısa notlar</div>
            </div>
          </div>
          <div class="cardBody">
            <div class="stack" style="gap:10px;">
              <div class="panel ok">
                <h3>Skor Mantığı</h3>
                <p>Her cevap ilgili persona(lar)a puan ekler. S4 çoklu seçim, kümülatiftir.</p>
              </div>
              <div class="panel">
                <h3>Eşitlik Kuralı</h3>
                <p>Skorlar eşitse önce S13 (bütçe), sonra S7 (stil) katkısı daha yüksek persona kazanır.</p>
              </div>
              <div class="panel">
                <h3>Hibrit Profil</h3>
                <p>Kazanan skor, toplam skorun %30 altındaysa Top1 + Top2 hibrit gösterilir.</p>
              </div>
              <div class="panel">
                <h3>Kısayollar</h3>
                <p><span class="kbd">←</span> geri, <span class="kbd">→</span> ileri, <span class="kbd">Esc</span> yeni görüşme</p>
              </div>
            </div>
          </div>
        </div>

        <div class="card" id="sideCard">
          <div class="cardHeader">
            <div>
              <h2>Özet</h2>
              <div class="sub">Seçim durumu</div>
            </div>
          </div>
          <div class="cardBody">
            <div class="panel">
              <p id="sideSummary" style="margin:0;">Başlamak için sol taraftan görüşme aç.</p>
            </div>
            <div class="mini">Otomatik kaydedilir. Tarayıcı kapanırsa kaldığın yerden devam eder.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footerNote">
      Bu uygulama tek dosya çalışır. Veri sadece bu cihazın tarayıcısında saklanır (LocalStorage).
    </div>
  </div>

  <script>
    // --- REVİZE EDİLMİŞ DENGELİ SORU HAVUZU (MAX PUAN ~100 EŞİTLENDİ) ---
    const questions = [
      {
        id: 1, text: "Bu mutfak projesinin niteliği nedir?", type: "single",
        options: [
          { text: "Kendi evim / Tadilat", scores: { p3: 5, p10: 5 } },
          { text: "Yeni Ev / Sıfır Proje", scores: { p1: 10, p2: 10, p7: 5 } },
          { text: "Yatırım / Stüdyo / Kiraya verilecek", scores: { p4: 30 } },
          { text: "Yazlık / İkinci Ev", scores: { p8: 40 } }
        ]
      },
      {
        id: 2, text: "Zaman kısıtınız nedir?", type: "single",
        options: [
          { text: "Çok acil, hemen bitmeli", scores: { p9: 40, p4: 10 } },
          { text: "Standart süreç (1-2 ay)", scores: { p3: 5, p5: 5 } },
          { text: "Zaman sorun değil, mükemmel olsun", scores: { p2: 15, p10: 15, p6: 10 } }
        ]
      },
      {
        id: 3, text: "Mutfak alanının durumu?", type: "single",
        options: [
          { text: "Dar / Küçük", scores: { p4: 15, p9: 10 } },
          { text: "Geniş / Ada Müsait", scores: { p7: 25, p5: 15, p2: 10 } },
          { text: "Standart", scores: { p3: 5 } }
        ]
      },
      {
        id: 4, text: "Hane Halkı (Birden fazla seçebilirsiniz)", type: "multi",
        options: [
          { text: "Yalnız / Çift", scores: { p1: 15, p4: 10, p5: 5 } },
          { text: "Çocuklar Var", scores: { p3: 20 } },
          { text: "Evcil Hayvan Var", scores: { p6: 15, p3: 10 } },
          { text: "Kalabalık Aile", scores: { p7: 15, p10: 10, p3: 10 } }
        ]
      },
      {
        id: 5, text: "Mutfak sizin için ne ifade ediyor?", type: "single",
        options: [
          { text: "Vitrin (Sosyal Alan)", scores: { p7: 30, p1: 10, p2: 10 } },
          { text: "Operasyon (Yemek Yapma)", scores: { p5: 35 } },
          { text: "Sığınak (Huzur)", scores: { p8: 25, p6: 20 } },
          { text: "Kalp (Aile Odaklı)", scores: { p10: 25, p3: 10 } },
          { text: "İstasyon (Pratik)", scores: { p9: 20, p4: 15 } }
        ]
      },
      {
        id: 6, text: "Şu anki mutfakta en büyük şikayetiniz?", type: "single",
        options: [
          { text: "Dağınıklık / Yer yok", scores: { p5: 15, p3: 5, p4: 5 } },
          { text: "Temizlik Zorluğu / Lekeler", scores: { p3: 15, p9: 10 } },
          { text: "Demode Görünüm", scores: { p1: 15, p2: 10, p7: 5 } },
          { text: "Karanlık / Basık", scores: { p8: 20, p6: 10 } }
        ]
      },
      {
        id: 7, text: "Hangi tasarım dili size yakın?", type: "single",
        options: [
          { text: "Modern & Minimal", scores: { p1: 20, p5: 10, p4: 5 } },
          { text: "Klasik & Gösterişli", scores: { p2: 30, p10: 10 } },
          { text: "Country & Doğal", scores: { p10: 30, p6: 20, p8: 15 } },
          { text: "Endüstriyel", scores: { p1: 15, p5: 15, p7: 10 } }
        ]
      },
      {
        id: 8, text: "Malzeme ve Doku tercihiniz?", type: "single",
        options: [
          { text: "Doğal Ahşap Dokusu", scores: { p6: 25, p10: 15, p8: 10 } },
          { text: "Mat ve Soft Renkler", scores: { p3: 15, p8: 15, p1: 5 } },
          { text: "Parlak ve Canlı", scores: { p2: 25, p7: 15 } },
          { text: "Koyu ve Maskülen", scores: { p1: 20, p5: 10 } }
        ]
      },
      {
        id: 9, text: "Yemek pişirme alışkanlığınız?", type: "single",
        options: [
          { text: "Standart Pişirme", scores: { p3: 10, p10: 5 } },
          { text: "Gurme / Profesyonel", scores: { p5: 40 } },
          { text: "Minimum / Pratik", scores: { p9: 20, p4: 15, p1: 5 } }
        ]
      },
      {
        id: 10, text: "Depolama ihtiyacınız?", type: "single",
        options: [
          { text: "Maksimum Kiler / Stok", scores: { p3: 15, p5: 15 } },
          { text: "Vitrin / Sergileme", scores: { p7: 20, p2: 15, p10: 10 } },
          { text: "Standart / Kapalı Dolap", scores: { p4: 10, p1: 5 } }
        ]
      },
      {
        id: 11, text: "Sürdürülebilirlik önceliğiniz?", type: "single",
        options: [
          { text: "Çok Önemli / Vazgeçilmez", scores: { p6: 40 } },
          { text: "Önemli ama estetik de önemli", scores: { p6: 15, p8: 10, p3: 5 } },
          { text: "Öncelik Değil", scores: { p4: 5, p9: 5 } }
        ]
      },
      {
        id: 12, text: "Teknoloji entegrasyonu?", type: "single",
        options: [
          { text: "High-Tech (Akıllı sistemler)", scores: { p1: 30, p5: 5 } },
          { text: "Geleneksel / Manuel", scores: { p10: 25, p6: 10, p8: 5 } }
        ]
      },
      {
        id: 13, text: "Bütçe yaklaşımınız?", type: "single",
        options: [
          { text: "Esnek / Prestij Odaklı", scores: { p2: 30, p1: 10, p7: 10 } },
          { text: "Fiyat / Performans", scores: { p3: 20, p5: 10, p10: 5 } },
          { text: "Ekonomik / Bütçe Dostu", scores: { p4: 25, p9: 15 } }
        ]
      },
      {
        id: 14, text: "Karar verme faktörünüz?", type: "single",
        options: [
          { text: "Tasarım Heyecanı", scores: { p1: 10, p2: 5, p7: 5 } },
          { text: "Güven / Garanti", scores: { p3: 15, p10: 5 } },
          { text: "Hız / Teslimat", scores: { p9: 30 } },
          { text: "Maliyet", scores: { p4: 15 } }
        ]
      }
    ];

    // Persona verisi: sonuç ekranındaki aksesuar, renk, malzeme önerileri buradan gelir
    const personasList = [
      {
        id: "p1",
        title: "Teknoloji Tutkunu Vizyoner",
        headline: "Mutfak Değil, Bir Teknoloji Üssü.",
        summary: "Sizin için net çizgiler, hız ve teknoloji her şeyden önce geliyor. Karmaşadan uzak, maskülen ve akıllı bir yaşam alanı arıyorsunuz.",
        model: "INOVA (Kulpsuz Tasarım)",
        material: "Mat Lake veya Soft Lak",
        color: "Renk: Koyu Taupe / Antrasit / Siyah",
        features: [
          "Tezgah Arası Priz Sistemleri (USB'li)",
          "Sensörlü LED Aydınlatmalı Çekmeceler",
          "Elektrikli Kalkar Kapak Mekanizması (Aventos)",
          "Legrabox Koyu Gri Çekmece Rayları"
        ],
        architectNote: "Koyu renklerde parmak izi kalmaması için Soft Lak yüzey numunesini ve antrasit gövde detayını gösterin."
      },
      {
        id: "p2",
        title: "Klasik Lüks Sever",
        headline: "Zamanın Ötesinde Bir Prestij.",
        summary: "Geçici trendler değil, kalıcı değerler peşindesiniz. Detaylardaki işçilik ve malzemenin ağırlığı sizin için kalite göstergesi.",
        model: "TOSCANA",
        material: "Parlak Lake (High Gloss)",
        color: "Renk: Porselen Mavi / Orman Yeşili / İnci Beyaz",
        features: [
          "Camlı Vitrin Dolaplar (İç Aydınlatmalı)",
          "Pirinç veya Gold detaylı Antique Kulplar",
          "Klasik Taç ve Işık Bandı Profilleri",
          "Porselen Eviye Uyumu"
        ],
        architectNote: "Toscana'nın çerçeve detaylarını ve parlak lakenin ışığı yansıtma kalitesini numune üzerinde vurgulayın."
      },
      {
        id: "p3",
        title: "Konfor Odaklı Aile",
        headline: "Hayatın Hızına Yetişen Dayanıklı Mutfak.",
        summary: "Çocuklar, evcil dostlar ve yoğun trafik. Sizin mutfağınızın her şeye dayanıklı olması ve her zaman temiz kalması gerekiyor.",
        model: "SIENA veya NORDA",
        material: "Tech-Matt (Mat PET) veya Akrilik",
        color: "Renk: Kaşmir / Manolya / Toprak Gri",
        features: [
          "Parmak İzi Bırakmayan (Anti-Fingerprint) Yüzey",
          "Boy Kiler Mekanizması (Dispensa)",
          "Tezgah Altı Çöp Ayrıştırma Sistemleri",
          "Evcil Hayvan Mama Kabı Modülü (Bazadan çıkan)"
        ],
        architectNote: "Mat PET yüzeye metal bir cisimle hafifçe dokunarak çizilme direncini ve leke tutmazlığını kanıtlayın."
      },
      {
        id: "p4",
        title: "Akıllı Yatırımcı (Micro-Living)",
        headline: "Akıllı Metrekareler, Yüksek Değer.",
        summary: "Pragmatiksiniz. Alan kısıtlı ama beklentiniz yüksek. Hedefiniz bütçeyi yormadan uzun ömürlü ve mekanı verimli kullanan bir çözüm.",
        model: "PRIME",
        material: "Melamin (Düz veya Dokulu)",
        color: "Renk: Sıcak Beyaz / Kum Beji / Açık Meşe",
        features: [
          "Yerden Tasarruf Sağlayan Açılır Masa",
          "Kör Köşe Mekanizması (Le Mans)",
          "Darbe Dayanımı Yüksek Melamin Kapaklar",
          "Laminant Tezgah (Hızlı Teslimat)"
        ],
        architectNote: "Fiyat/Performans oranını vurgulamak için Prime serisinin modüler hızını ve melaminin dayanıklılığını anlatın."
      },
      {
        id: "p5",
        title: "Gurme Şef",
        headline: "Evinizin Profesyonel Lezzet İstasyonu.",
        summary: "Yemek yapmak sizin için bir sanat. Tezgahınız atölyeniz. İhtiyacınız estetikten öte kusursuz bir operasyonel akış.",
        model: "INOVA (+5cm Yüksek Gövde)",
        material: "Metal Görünümlü Laminat veya Soft Lak",
        color: "Renk: Grafit / Paslanmaz Çelik Efekti / Beton Gri",
        features: [
          "Orgalux Ahşap Çekmece İçi Düzenleyiciler",
          "78 cm Yüksek Gövde (%20 Fazla Hacim)",
          "Sanayi Tipi Eviye ve Batarya",
          "Ergonomik (Yükseltilmiş) Bulaşık Makinesi Modülü"
        ],
        architectNote: "Müşteriyi standart modül ile +5cm yüksek modül yanına götürüp ergonomi farkını deneyimletin."
      },
      {
        id: "p6",
        title: "Doğal Yaşam Savunucusu",
        headline: "Doğanın Huzuru Mutfağınızda.",
        summary: "Sürdürülebilirlik bir yaşam biçimi. Mutfağınız nefes almalı, doğal malzemelerle ruhunuzu dinlendirmeli.",
        model: "NORDA",
        material: "Doğal Ahşap Kaplama & Geri Dönüştürülmüş PET",
        color: "Renk: Ada Çayı Yeşili / Meşe / Yaprak Yeşili",
        features: [
          "Micro Garden (Ledli Bitki Yetiştirme Ünitesi)",
          "Ahşap Açık Raf Sistemleri",
          "Geri Dönüştürülmüş Malzemeden Kapaklar",
          "Doğal Ahşap Tezgah Uyumu"
        ],
        architectNote: "Kataloğun sürdürülebilirlik sayfasındaki PET malzemenin geri dönüşüm hikayesini anlatın."
      },
      {
        id: "p7",
        title: "Sosyal Ev Sahibi",
        headline: "Sadece Yemek Değil, Sohbet Pişirilen Yer.",
        summary: "Mutfak sizin sahneniz. Dostlarınızla kadeh kaldırdığınız, yemek yaparken sohbetin kesilmediği, salonla bütünleşen bir alan.",
        model: "INOVA (Ada Planlaması)",
        material: "Kombinasyon: Ahşap ve Mat Lake",
        color: "Renk: Koyu Ceviz ve Kaşmir Kontrastı",
        features: [
          "Ada Çevresi Oturma Alanı (Bar)",
          "Şaraplık ve Kadehlik Modülleri",
          "Dekoratif Metal Açık Raflar (Tavan tipi)",
          "Ambiyans Aydınlatması (Dimmerli)"
        ],
        architectNote: "Ada mutfağın salona bakan yüzünde vitrin veya açık raf kullanarak geçişi nasıl yumuşatacağınızı çizin."
      },
      {
        id: "p8",
        title: "Dinginlik Arayan (Yazlık Ruhu)",
        headline: "Her Gün Tatil Sabahına Uyanmak Gibi.",
        summary: "Şehrin griliğinden kaçış arıyorsunuz. Mutfağınız sahil evinin ferahlığını, denizin mavisini ve sakinliği vermeli.",
        model: "FRESCA",
        material: "Mat Yüzey (Özel Dokulu)",
        color: "Renk: Okyanus Mavi / Beyaz / Pastel Yeşil",
        features: [
          "Dikey Çizgili Fresca Kapak Dokusu",
          "Pencere Önü Eviye Yerleşimi",
          "Hasır Sepetli Çekmeceler",
          "Minimal Krom Kulplar"
        ],
        architectNote: "Fresca'nın çizgili dokusuna dokunmalarını sağlayın, ışık gölge oyununu gösterin."
      },
      {
        id: "p9",
        title: "Hız ve Pratiklik Odaklı",
        headline: "Beklemeden Yeni Mutfağınıza Kavuşun.",
        summary: "Kararınızı verdiniz ve sonuç istiyorsunuz. Tadilat süreci gözünüzde büyümesin. Sizin için hız, pratiklik ve hemen kullanım önemli.",
        model: "PRIME (Stoklu Program)",
        material: "Hazır Stok Laminant",
        color: "Renk: Standart Beyaz veya Gri",
        features: [
          "Hemen Teslim (Stoklu Modüller)",
          "Tezgah Arası Raylı Aksesuar Seti (Pratik)",
          "Kapağa Monteli Çöp Kovası",
          "Kolay Temizlenen Yüzeyler"
        ],
        architectNote: "Teslimat takvimini açıp net tarih verin (örnek: 3 hafta)."
      },
      {
        id: "p10",
        title: "Nostaljik Romantik",
        headline: "Geçmişin Sıcaklığı, Bugünün Konforu.",
        summary: "Modernizmin soğukluğu size göre değil. Siz yaşanmışlık hissi veren, anne mutfağı sıcaklığında duygusal bir yer istiyorsunuz.",
        model: "VEGA",
        material: "Lake Görünümlü Polimerik",
        color: "Renk: Manolya / Fırtına Mavi / Süt Kahve",
        features: [
          "Kafes Telli Camlı Dolaplar",
          "Rustik / Porselen / Eskitme Kulplar",
          "Baharatlık Çekmeceleri",
          "Ahşap Tabaklık Modülleri"
        ],
        architectNote: "Kafes telli cam kapağı ve porselen kulpları göstererek vintage atmosferi hissettirin."
      }
    ];

    const personas = Object.fromEntries(personasList.map(p => [p.id, p]));
    const personaOrder = ["p1","p2","p3","p4","p5","p6","p7","p8","p9","p10"];

    const STORAGE_KEY = "intema_mimar_asistan_v4";

    const state = {
      step: "start",
      qIndex: 0,
      answers: {},
      meta: { name:"", phone:"", email:"", note:"" },
      mode: "client"
    };

    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(deepClone(state)));
      updateSessionPill();
      updateSideSummary();
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return false;
        const payload = JSON.parse(raw);
        if(!payload || typeof payload !== "object") return false;
        Object.assign(state, payload);
        return true;
      }catch(e){
        return false;
      }
    }

    function clearStorage(){ localStorage.removeItem(STORAGE_KEY); }

    function resetAll({ keepMeta=false } = {}){
      const preserved = keepMeta ? deepClone(state.meta) : { name:"", phone:"", email:"", note:"" };
      state.step = "start";
      state.qIndex = 0;
      state.answers = {};
      state.mode = "client";
      state.meta = preserved;
      save();
      render();
    }

    function startQuiz(){
      state.step = "quiz";
      state.qIndex = Math.max(0, Math.min(state.qIndex || 0, questions.length - 1));
      save();
      render();
    }

    function currentQuestion(){ return questions[state.qIndex]; }

    function isAnswered(q){
      const a = state.answers[q.id];
      if(q.type === "single") return typeof a === "number";
      if(q.type === "multi") return Array.isArray(a) && a.length > 0;
      return false;
    }

    function selectOption(q, optIndex){
      if(q.type === "single"){
        state.answers[q.id] = optIndex;
      }else{
        const cur = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [];
        state.answers[q.id] = cur.includes(optIndex) ? cur.filter(i=>i!==optIndex) : [...cur, optIndex];
      }
      save();
      render();
    }

    function totalProgress(){
      const answeredCount = questions.reduce((acc,q)=>acc + (isAnswered(q)?1:0), 0);
      return { answeredCount, total: questions.length };
    }

    function calcScores(){
      const scores = {};
      const contrib = {};
      personaOrder.forEach(p => scores[p] = 0);

      for(const q of questions){
        const ans = state.answers[q.id];
        if(ans === undefined) continue;

        contrib[q.id] = {};
        personaOrder.forEach(p => contrib[q.id][p] = 0);

        if(q.type === "single"){
          const opt = q.options[ans];
          if(opt && opt.scores){
            for(const [p,val] of Object.entries(opt.scores)){
              if(scores[p] === undefined) continue;
              scores[p] += val;
              contrib[q.id][p] += val;
            }
          }
        }else if(q.type === "multi"){
          const arr = Array.isArray(ans) ? ans : [];
          for(const idx of arr){
            const opt = q.options[idx];
            if(opt && opt.scores){
              for(const [p,val] of Object.entries(opt.scores)){
                if(scores[p] === undefined) continue;
                scores[p] += val;
                contrib[q.id][p] += val;
              }
            }
          }
        }
      }

      const total = Object.values(scores).reduce((a,b)=>a+b,0);
      return { scores, contrib, total };
    }

    function pickWinner({ scores, contrib }){
      const entries = personaOrder.map(p => ({ p, score: scores[p] }));
      entries.sort((a,b)=> b.score - a.score);

      const topScore = entries[0].score;
      const tied = entries.filter(e => e.score === topScore).map(e=>e.p);

      if(tied.length === 1){
        return { winner: tied[0], tied, reason: "max" };
      }

      const qBudget = 13;
      const qStyle = 7;

      const pickByContribution = (qId, candidates) => {
        const c = candidates.map(p => ({ p, c: (contrib[qId] && contrib[qId][p]) ? contrib[qId][p] : 0 }));
        c.sort((a,b)=> b.c - a.c);
        const maxC = c[0].c;
        const best = c.filter(x => x.c === maxC).map(x=>x.p);
        return { best, maxC };
      };

      const b1 = pickByContribution(qBudget, tied);
      if(b1.best.length === 1 && b1.maxC > 0){
        return { winner: b1.best[0], tied, reason: "tie_budget" };
      }

      const b2 = pickByContribution(qStyle, (b1.best.length ? b1.best : tied));
      if(b2.best.length === 1 && b2.maxC > 0){
        return { winner: b2.best[0], tied, reason: "tie_style" };
      }

      const fallback = personaOrder.find(p => tied.includes(p)) || tied[0];
      return { winner: fallback, tied, reason: "tie_fallback" };
    }

    function calcHybrid({ scores, total }){
      const entries = personaOrder.map(p => ({ p, score: scores[p] })).sort((a,b)=> b.score - a.score);
      const top1 = entries[0];
      const top2 = entries[1] || { p: top1.p, score: 0 };

      const topShare = total > 0 ? (top1.score / total) : 0;
      const isDominant = topShare >= 0.30;

      return {
        isDominant,
        top1,
        top2,
        topShare,
        top2Share: total > 0 ? (top2.score / total) : 0
      };
    }

    function petTriggered(){
      const ans = state.answers[4];
      return Array.isArray(ans) && ans.includes(2);
    }

    function childrenAndPetRisk(){
      const ans = state.answers[4];
      return Array.isArray(ans) && ans.includes(1) && ans.includes(2);
    }

    function formatPct(x){ return (x*100).toFixed(0) + "%"; }

    function resultPackage(){
      const { scores, contrib, total } = calcScores();
      const { winner, tied, reason } = pickWinner({ scores, contrib });
      const hybrid = calcHybrid({ scores, total });

      const list = personaOrder
        .map(p => ({ p, score: scores[p], share: total>0 ? scores[p]/total : 0 }))
        .sort((a,b)=> b.score - a.score);

      return { scores, total, winner, tied, reason, hybrid, list };
    }

    function buildSummaryText(res){
      if(!res.hybrid.isDominant){
        return `Hibrit profil: ${personas[res.hybrid.top1.p].title} (${formatPct(res.hybrid.topShare)}) + ${personas[res.hybrid.top2.p].title} (${formatPct(res.hybrid.top2Share)})`;
      }
      return `Kazanan profil: ${personas[res.winner].title} (${formatPct(res.hybrid.topShare)})`;
    }

    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(text);
      }
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    function render(){
      updateSessionPill();
      updateSideSummary();

      const main = el("#mainCard");
      if(state.step === "start"){
        main.innerHTML = renderStart();
        bindStart();
        return;
      }
      if(state.step === "quiz"){
        main.innerHTML = renderQuiz();
        bindQuiz();
        return;
      }
      if(state.step === "result"){
        main.innerHTML = renderResult();
        bindResult();
        return;
      }
      state.step = "start";
      save();
      main.innerHTML = renderStart();
      bindStart();
    }

    function renderStart(){
      const prog = totalProgress();
      const hasSaved = prog.answeredCount > 0;
      return `
        <div class="cardHeader">
          <div>
            <h2>Görüşme Bilgisi</h2>
            <div class="sub">Opsiyonel alanlar. İstersen boş geç.</div>
          </div>
          <div class="toggleRow">
            ${hasSaved ? `<span class="badge"><strong>Kayıt:</strong> Devam edilebilir</span>` : `<span class="badge"><strong>Kayıt:</strong> Yeni</span>`}
          </div>
        </div>

        <div class="cardBody">
          <div class="stack">
            <div class="fieldRow">
              <label>
                Müşteri Ad Soyad
                <input type="text" id="metaName" placeholder="Örn: Ayşe Yılmaz" value="${escapeHtml(state.meta.name)}" />
              </label>
              <label>
                Telefon
                <input type="tel" id="metaPhone" placeholder="Örn: 05xx xxx xx xx" value="${escapeHtml(state.meta.phone)}" />
              </label>
            </div>

            <div class="fieldRow">
              <label>
                E-posta
                <input type="email" id="metaEmail" placeholder="Örn: ayse@mail.com" value="${escapeHtml(state.meta.email)}" />
              </label>
              <label>
                İç Not (Kısa)
                <input type="text" id="metaQuick" placeholder="Örn: Ada istiyor, teslim acil" value="" />
              </label>
            </div>

            <label>
              Proje Notu
              <textarea id="metaNote" placeholder="Kısa notlar, beklenti, kritik detaylar...">${escapeHtml(state.meta.note)}</textarea>
              <div class="hint">Notlar sadece bu cihazda saklanır.</div>
            </label>

            <div class="navRow">
              <div class="left">
                <button class="btn ghost" id="btnContinue" ${hasSaved ? "" : "disabled"}>Devam Et</button>
                <button class="btn" id="btnStartNew">Ankete Başla</button>
              </div>
              <div class="right">
                <button class="btn danger" id="btnClearSaved">Kaydı Sil</button>
              </div>
            </div>

            <div class="mini">
              İpucu: Kayıt varsa <span class="kbd">Devam Et</span> kaldığın soruya gider. Yoksa 1. sorudan başlar.
            </div>
          </div>
        </div>
      `;
    }

    function renderQuiz(){
      const q = currentQuestion();
      const prog = totalProgress();
      const pct = Math.round(((state.qIndex) / (questions.length - 1)) * 100);
      const answered = isAnswered(q);

      const selected = state.answers[q.id];
      const optionHtml = q.options.map((o, idx) => {
        const isSel = q.type === "single"
          ? selected === idx
          : (Array.isArray(selected) && selected.includes(idx));

        const cls = ["opt", q.type === "multi" ? "multi" : "", isSel ? "sel" : ""].join(" ").trim();
        return `
          <div class="${cls}" data-opt="${idx}" role="button" tabindex="0" aria-pressed="${isSel}">
            <div>
              <div class="t">${escapeHtml(o.text)}</div>
              <div class="tag">${q.type === "multi" ? "Çoklu seçim" : "Tek seçim"}</div>
            </div>
            <div class="mark" aria-hidden="true"></div>
          </div>
        `;
      }).join("");

      const canNext = answered;
      const isLast = state.qIndex === questions.length - 1;

      return `
        <div class="progressWrap">
          <div class="progressLeft">
            <div class="qMeta">Soru ${state.qIndex + 1} / ${questions.length} • Cevaplanan: ${prog.answeredCount}/${prog.total}</div>
            <p class="qText">${escapeHtml(q.text)}</p>
          </div>
          <div class="bar" aria-label="İlerleme">
            <div style="width:${pct}%"></div>
          </div>
        </div>

        <div class="cardBody">
          <div class="options" id="optList">${optionHtml}</div>

          <div class="navRow">
            <div class="left">
              <button class="btn ghost" id="btnBack" ${state.qIndex === 0 ? "disabled" : ""}>Geri</button>
              <button class="btn ${isLast ? "primary" : ""}" id="btnNext" ${canNext ? "" : "disabled"}>
                ${isLast ? "Sonucu Gör" : "İleri"}
              </button>
            </div>
            <div class="right">
              <button class="btn ghost" id="btnJumpStart">Başlangıç</button>
              <button class="btn danger" id="btnClearAnswers">Cevapları Temizle</button>
            </div>
          </div>

          <div class="mini">
            ${q.type === "multi" ? "Birden fazla seçenek işaretleyebilirsin. İleri için en az bir seçim şart." : "İleri için seçim şart."}
          </div>
        </div>
      `;
    }

    function renderResult(){
      const res = resultPackage();
      const winnerId = res.winner;
      const winnerData = personas[winnerId];

      const hybrid = res.hybrid;
      const isHybrid = !hybrid.isDominant;

      const topLabel = isHybrid ? `Hibrit Profil` : `Kazanan Profil`;
      const badgeText = isHybrid
        ? `${personas[hybrid.top1.p].title} (${formatPct(hybrid.topShare)}) + ${personas[hybrid.top2.p].title} (${formatPct(hybrid.top2Share)})`
        : `${winnerData.title} (${formatPct(hybrid.topShare)})`;

      const pet = petTriggered();
      const risk = childrenAndPetRisk();

      const recBlock = isHybrid
        ? buildHybridRec(personas[hybrid.top1.p], personas[hybrid.top2.p])
        : buildRec(winnerData);

      const modeClientOn = state.mode === "client" ? "on" : "";
      const modeArchOn = state.mode === "architect" ? "on" : "";

      const scoreTableRows = res.list.map(row => `
        <tr>
          <td><strong>${escapeHtml(personas[row.p].title)}</strong></td>
          <td>${row.score}</td>
          <td>${formatPct(row.share)}</td>
        </tr>
      `).join("");

      const archOnly = state.mode === "architect" ? "" : "hide";
      const clientOnly = state.mode === "client" ? "" : "hide";

      return `
        <div class="resultHero">
          <div class="resultTop">
            <div>
              <div class="badge"><strong>${escapeHtml(topLabel)}:</strong> ${escapeHtml(badgeText)}</div>
              <h2 class="resultTitle">${escapeHtml(isHybrid ? "İki güçlü persona öne çıkıyor." : winnerData.headline)}</h2>
              <p class="resultDesc ${clientOnly}">${escapeHtml(buildClientSummary(res))}</p>
              <p class="resultDesc ${archOnly}">${escapeHtml(buildArchitectSummary(res))}</p>
            </div>

            <div class="toggleRow">
              <div class="seg" role="tablist" aria-label="Mod">
                <button id="btnModeClient" class="${modeClientOn}" role="tab" aria-selected="${state.mode==="client"}">Müşteri Modu</button>
                <button id="btnModeArch" class="${modeArchOn}" role="tab" aria-selected="${state.mode==="architect"}">Mimar Modu</button>
              </div>
            </div>
          </div>
        </div>

        <div class="split">
          ${risk ? `
            <div class="panel alert">
              <h3>Sistem Uyarısı: Yüksek Aşınma Riski</h3>
              <ul>
                <li>Kapak önerisi: Tech-Matt (Mat PET) veya Akrilik, daha dayanıklı kullanım.</li>
                <li>Modül önerisi: Çöp ayrıştırma ve çekmece içi düzenleyici ile temizlik akışını hızlandırın.</li>
                <li>Güvenlik: Çocuklar için kilit, hassas yüzeylerde koruma yaklaşımı.</li>
              </ul>
            </div>
          ` : ""}

          <div class="panel">
            <h3>Öneri Reçetesi</h3>
            ${recBlock}
          </div>

          ${pet ? `
            <div class="panel ok">
              <h3>Pet Modülü Kartı</h3>
              <ul>
                <li>Evcil hayvan mama kabı modülü gibi günlük pratik sağlayan çözümleri gösterin.</li>
                <li>Anti-fingerprint ve kolay silinen yüzey yönünü öne çıkarın.</li>
                <li>Kapalı depolama ve çöp ayrıştırma ile hijyen akışını netleştirin.</li>
              </ul>
            </div>
          ` : ""}

          <div class="panel ${archOnly}">
            <h3>Skor Dağılımı</h3>
            <table>
              <thead>
                <tr>
                  <th>Persona</th>
                  <th>Skor</th>
                  <th>Pay</th>
                </tr>
              </thead>
              <tbody>${scoreTableRows}</tbody>
            </table>
            <div class="mini">Dominant kuralı toplam skorun %30 eşiğine göre hesaplanır.</div>
          </div>

          <div class="panel">
            <h3>Mimar Notu</h3>
            <textarea id="archNote" placeholder="Kısa satış yönlendirmesi, kritik istekler, takip notu...">${escapeHtml(state.meta.note || "")}</textarea>
            <div class="navRow" style="margin-top:10px;">
              <div class="left">
                <button class="btn" id="btnSaveNote">Notu Kaydet</button>
                <button class="btn ghost" id="btnBackToQuiz">Ankete Dön</button>
              </div>
              <div class="right">
                <button class="btn" id="btnCopy">Özeti Kopyala</button>
                <button class="btn ghost" id="btnPrint">Yazdır</button>
                <button class="btn primary" id="btnNewFromResult">Yeni Görüşme</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function buildRec(p){
      const feats = (p.features || []).map(x=>`<li>${escapeHtml(x)}</li>`).join("");
      const archOnly = state.mode === "architect" ? "" : "hide";

      return `
        <div class="stack" style="gap:10px;">
          <div class="panel">
            <h3>${escapeHtml(p.title)}</h3>
            <p><strong>${escapeHtml(p.headline)}</strong></p>
            <p>${escapeHtml(p.summary)}</p>
          </div>

          <div class="panel">
            <h3>Model</h3>
            <p><strong>${escapeHtml(p.model)}</strong></p>
          </div>

          <div class="panel">
            <h3>Malzeme ve Renk</h3>
            <ul>
              <li><strong>Malzeme:</strong> ${escapeHtml(p.material)}</li>
              <li><strong>${escapeHtml(p.color)}</strong></li>
            </ul>
          </div>

          <div class="panel">
            <h3>Önerilen Özellikler</h3>
            <ul>${feats}</ul>
          </div>

          <div class="panel ${archOnly}">
            <h3>Mimar Notu (Öneri)</h3>
            <p>${escapeHtml(p.architectNote || "")}</p>
          </div>
        </div>
      `;
    }

    function buildHybridRec(a, b){
      const headline = `Hibrit: ${a.title} + ${b.title}`;
      const mergedFeatures = unique([...(a.features||[]), ...(b.features||[])]).slice(0, 8);
      const feats = mergedFeatures.map(x=>`<li>${escapeHtml(x)}</li>`).join("");
      const archOnly = state.mode === "architect" ? "" : "hide";

      return `
        <div class="stack" style="gap:10px;">
          <div class="panel">
            <h3>${escapeHtml(headline)}</h3>
            <p><strong>${escapeHtml(a.headline)}</strong></p>
            <p>${escapeHtml(a.summary)}</p>
            <p style="margin-top:10px;"><strong>${escapeHtml(b.headline)}</strong></p>
            <p>${escapeHtml(b.summary)}</p>
          </div>

          <div class="panel">
            <h3>Model Yönü</h3>
            <ul>
              <li><strong>${escapeHtml(a.title)}:</strong> ${escapeHtml(a.model)}</li>
              <li><strong>${escapeHtml(b.title)}:</strong> ${escapeHtml(b.model)}</li>
            </ul>
          </div>

          <div class="panel">
            <h3>Malzeme ve Renk</h3>
            <ul>
              <li><strong>${escapeHtml(a.title)}:</strong> ${escapeHtml(a.material)} | ${escapeHtml(a.color)}</li>
              <li><strong>${escapeHtml(b.title)}:</strong> ${escapeHtml(b.material)} | ${escapeHtml(b.color)}</li>
            </ul>
          </div>

          <div class="panel">
            <h3>Birleşik Özellikler</h3>
            <ul>${feats}</ul>
          </div>

          <div class="panel ${archOnly}">
            <h3>Mimar Notları (Öneri)</h3>
            <ul>
              <li><strong>${escapeHtml(a.title)}:</strong> ${escapeHtml(a.architectNote || "")}</li>
              <li><strong>${escapeHtml(b.title)}:</strong> ${escapeHtml(b.architectNote || "")}</li>
            </ul>
          </div>
        </div>
      `;
    }

    function buildClientSummary(res){
      const base = buildSummaryText(res);
      const name = state.meta.name ? `${state.meta.name} için ` : "";
      const pet = petTriggered() ? " Evcil hayvan detayı var. Dayanıklı ve kolay temizlenen yüzey yönü güçlenir." : "";
      return `${name}${base}. Şimdi bu profile göre model, malzeme ve renk setini netleştirip hızlıca görsel dil kurabiliriz.${pet}`;
    }

    function buildArchitectSummary(res){
      const base = buildSummaryText(res);
      const risk = childrenAndPetRisk() ? " Çocuk ve evcil hayvan birlikte. Aşınma riski uyarısı aktif." : "";
      return `${base}. Tie-break: ${res.reason}. Toplam skor: ${res.total}.${risk}`;
    }

    function updateSessionPill(){
      const prog = totalProgress();
      el("#sessionState").textContent = (prog.answeredCount > 0) ? `Devam (${prog.answeredCount}/${prog.total})` : "Yeni";
    }

    function updateSideSummary(){
      const side = el("#sideSummary");
      if(!side) return;

      const prog = totalProgress();

      if(state.step === "result"){
        side.textContent = buildSummaryText(resultPackage());
        return;
      }

      if(prog.answeredCount === 0){
        side.textContent = "Başlamak için görüşme bilgisi gir veya direkt ankete başla.";
        return;
      }

      const q = questions[state.qIndex] || questions[0];
      side.textContent = `İlerleme: ${prog.answeredCount}/${prog.total}. Şu an: Soru ${state.qIndex+1}. ${isAnswered(q) ? "Seçildi." : "Seçim bekliyor."}`;
    }

    function bindStart(){
      const name = el("#metaName");
      const phone = el("#metaPhone");
      const email = el("#metaEmail");
      const note = el("#metaNote");
      const quick = el("#metaQuick");

      const sync = () => {
        state.meta.name = name.value.trim();
        state.meta.phone = phone.value.trim();
        state.meta.email = email.value.trim();
        state.meta.note = note.value.trim();
        save();
      };

      [name,phone,email,note].forEach(x => x.addEventListener("input", sync));

      if(quick){
        quick.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){
            e.preventDefault();
            const v = quick.value.trim();
            if(v){
              state.meta.note = (state.meta.note ? (state.meta.note + "\n") : "") + v;
              quick.value = "";
              save();
              render();
            }
          }
        });
      }

      const prog = totalProgress();
      el("#btnContinue").addEventListener("click", ()=>{
        if(prog.answeredCount === 0) return;
        startQuiz();
      });

      el("#btnStartNew").addEventListener("click", ()=>{
        state.qIndex = 0;
        state.step = "quiz";
        save();
        render();
      });

      el("#btnClearSaved").addEventListener("click", ()=>{
        clearStorage();
        resetAll({ keepMeta:false });
      });
    }

    function bindQuiz(){
      const q = currentQuestion();
      const optList = el("#optList");
      els(".opt", optList).forEach(node => {
        node.addEventListener("click", () => selectOption(q, Number(node.dataset.opt)));
        node.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            selectOption(q, Number(node.dataset.opt));
          }
        });
      });

      el("#btnBack").addEventListener("click", ()=>{
        if(state.qIndex <= 0) return;
        state.qIndex -= 1;
        save();
        render();
      });

      el("#btnNext").addEventListener("click", ()=>{
        if(!isAnswered(q)) return;
        if(state.qIndex >= questions.length - 1){
          state.step = "result";
          save();
          render();
          return;
        }
        state.qIndex += 1;
        save();
        render();
      });

      el("#btnJumpStart").addEventListener("click", ()=>{
        state.step = "start";
        save();
        render();
      });

      el("#btnClearAnswers").addEventListener("click", ()=>{
        state.answers = {};
        state.qIndex = 0;
        save();
        render();
      });
    }

    function bindResult(){
      el("#btnModeClient").addEventListener("click", ()=>{
        state.mode = "client";
        save();
        render();
      });
      el("#btnModeArch").addEventListener("click", ()=>{
        state.mode = "architect";
        save();
        render();
      });

      el("#btnBackToQuiz").addEventListener("click", ()=>{
        state.step = "quiz";
        state.qIndex = questions.length - 1;
        save();
        render();
      });

      el("#btnNewFromResult").addEventListener("click", ()=> resetAll({ keepMeta:true }));

      const note = el("#archNote");
      el("#btnSaveNote").addEventListener("click", ()=>{
        state.meta.note = note.value.trim();
        save();
        render();
      });

      el("#btnCopy").addEventListener("click", async ()=>{
        const res = resultPackage();
        const lines = [];
        if(state.meta.name) lines.push(`Müşteri: ${state.meta.name}`);
        if(state.meta.phone) lines.push(`Telefon: ${state.meta.phone}`);
        if(state.meta.email) lines.push(`E-posta: ${state.meta.email}`);
        lines.push(buildSummaryText(res));

        if(!res.hybrid.isDominant){
          const a = personas[res.hybrid.top1.p];
          const b = personas[res.hybrid.top2.p];
          lines.push(`Top1: ${a.title} | ${a.model} | ${a.material} | ${a.color}`);
          lines.push(`Top2: ${b.title} | ${b.model} | ${b.material} | ${b.color}`);
        }else{
          const p = personas[res.winner];
          lines.push(`${p.title}: ${p.headline}`);
          lines.push(`Model: ${p.model}`);
          lines.push(`Malzeme: ${p.material}`);
          lines.push(`${p.color}`);
          lines.push(`Öne Çıkanlar: ${p.features.slice(0,4).join(" | ")}`);
          if(state.mode === "architect" && p.architectNote) lines.push(`Mimar Notu: ${p.architectNote}`);
        }

        if(childrenAndPetRisk()) lines.push("Uyarı: Çocuklar ve evcil hayvan birlikte. Aşınma riski yüksek.");
        if(petTriggered()) lines.push("Not: Evcil hayvan seçimi var. Dayanıklı yüzey ve hijyen akışı öncelikli.");
        if(state.meta.note) lines.push(`Mimar Notu (Kayıt): ${state.meta.note}`);

        try{
          await copyToClipboard(lines.join("\n"));
          flashPill("Kopyalandı");
        }catch(e){
          flashPill("Kopyalama başarısız");
        }
      });

      el("#btnPrint").addEventListener("click", ()=> window.print());
    }

    function flashPill(msg){
      const pill = el("#sessionPill");
      const old = el("#sessionState").textContent;
      el("#sessionState").textContent = msg;
      pill.style.borderColor = "rgba(140,200,255,.42)";
      pill.style.background = "rgba(140,200,255,.16)";
      setTimeout(()=>{
        pill.style.borderColor = "";
        pill.style.background = "";
        el("#sessionState").textContent = old;
      }, 900);
    }

    el("#btnNew").addEventListener("click", ()=> resetAll({ keepMeta:true }));
    el("#btnReset").addEventListener("click", ()=> resetAll({ keepMeta:false }));

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        e.preventDefault();
        resetAll({ keepMeta:true });
        return;
      }
      if(state.step !== "quiz") return;
      if(e.key === "ArrowLeft"){
        e.preventDefault();
        const b = el("#btnBack");
        if(b && !b.disabled) b.click();
      }
      if(e.key === "ArrowRight"){
        e.preventDefault();
        const n = el("#btnNext");
        if(n && !n.disabled) n.click();
      }
    });

    function unique(arr){
      const s = new Set();
      const out = [];
      for(const x of arr){
        if(!s.has(x)){ s.add(x); out.push(x); }
      }
      return out;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const hasLoaded = load();
    if(!hasLoaded) save();

    if(state.step === "quiz" && (state.qIndex == null || isNaN(state.qIndex))) state.qIndex = 0;
    if(state.step === "result" && totalProgress().answeredCount === 0) state.step = "start";

    render();
  </script>
</body>
</html>
